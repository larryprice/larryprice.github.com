
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Larry Price</title>
  <meta name="author" content="Larry Price">

  
  <meta name="description" content="Confining a Snapped X11 Application Dec 10th, 2016 5:30 pm | Comments Looking for the code? Look no further: https://github.com/larryprice/pingus- &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://larry-price.com/posts/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Larry Price" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat+Alternates|Marcellus' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35669093-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner" style="background:url(/images/coffee-stain.png) top right no-repeat; background-size: auto 100%;"><hgroup>
  <h1><a href="/">Larry Price</a></h1>
  
    <h2>And The Endless Cup Of Coffee</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:larry-price.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/books">Books</a></li>
  <li><a href="/blog/projects">Projects</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/10/confining-a-snapped-x11-application/">Confining a Snapped X11 Application</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-10T17:30:38-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>5:30 pm</span></time>
        
           | <a href="/blog/2016/12/10/confining-a-snapped-x11-application/#disqus_thread"
             data-disqus-identifier="https://larry-price.com/blog/2016/12/10/confining-a-snapped-x11-application/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>Looking for the code? Look no further: <a href="https://github.com/larryprice/pingus-snap">https://github.com/larryprice/pingus-snap</a></em></p>

<p>In my <a href="/blog/2016/12/07/creating-a-snap-from-existing-deb-packages/">last post</a>, I demonstrated creating a snap package for an application available in the archive. I left that application unconfined, which is taboo in the long run if we want our system to be secure. In a few steps, we can add the necessary components to confine our <code>pingus</code> snap.</p>

<p>For reference, this is the original <code>snapcraft.yaml</code> file for creating a <code>pingus</code> snap, except that we&rsquo;ve updated the <code>confinement</code> property to <code>strict</code>:</p>

<figure class='code'><figcaption><span>snapcraft.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;0.1&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">summary</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Free Lemmings(TM) clone</span>
</span><span class='line'><span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>    <span class="no">Pingus is a free clone of the popular Lemmings game.</span>
</span><span class='line'>    <span class="no">|</span>
</span><span class='line'>    <span class="no">Your goal is to guide a horde of penguins through a world full of obstacles</span>
</span><span class='line'>    <span class="no">and penguin traps to safety. Although penguins (unlike lemmings) are rather</span>
</span><span class='line'>    <span class="no">smart, they sometimes lack the necessary overview and now rely on you to</span>
</span><span class='line'>    <span class="no">save them.</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">grade</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">devel</span>
</span><span class='line'><span class="l-Scalar-Plain">confinement</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">strict</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">parts</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">archives</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nil</span>
</span><span class='line'>    <span class="l-Scalar-Plain">stage-packages</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'>  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dump</span>
</span><span class='line'>    <span class="l-Scalar-Plain">organize</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">pingus.wrapper</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">usr/bin/pingus</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">apps</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pingus</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pingus</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re feeling bold, you can build and install the snap from here, but be warned that this led me into an ncurses nightmare that I had to forcibly kill. That&rsquo;s largely because <code>pingus</code> depends on X11, which is not available out-of-the-box once we&rsquo;ve confined our snap. If we want to use X11, we&rsquo;re going to need to connect to it using the snap-land concept of <a href="http://snapcraft.io/docs/core/interfaces">interfaces</a>. Interfaces allow us to access shared resources and connections provided by the system or other snaps. There&rsquo;s some terminology to grapple with here, but the bottom line is that a &ldquo;slot&rdquo; provides an interface which a &ldquo;plug&rdquo; connects to. You can see a big list of available interfaces with descriptions <a href="http://snapcraft.io/docs/reference/interfaces">on the wiki</a>. Our <code>pingus</code> app will &ldquo;plug&rdquo; into the X11 interface&rsquo;s &ldquo;slot&rdquo;:</p>

<figure class='code'><figcaption><span>snapcraft.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># ...</span>
</span><span class='line'><span class="l-Scalar-Plain">apps</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pingus</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">x11</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can build and install the new snap with the <code>--dangerous</code> flag for your local confined snap. After that, you can verify the interface connection with the <code>snap interfaces</code> command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>snapcraft
</span><span class='line'><span class="nv">$ </span>sudo snap install --dangerous pingus_0.1_amd64.snap
</span><span class='line'>pingus 0.1 installed
</span><span class='line'><span class="nv">$ </span>snap interfaces
</span><span class='line'>Slot                     Plug
</span><span class='line'>:alsa                    -
</span><span class='line'><span class="c"># ...</span>
</span><span class='line'>:upower-observe          -
</span><span class='line'>:x11                     pingus
</span></code></pre></td></tr></table></div></figure>


<p>Now, when we run <code>pingus</code>&hellip; it works! Well, video works. If you want sound, we&rsquo;ll also need the <code>pulseaudio</code> interface:</p>

<figure class='code'><figcaption><span>snapcraft.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># ...</span>
</span><span class='line'><span class="l-Scalar-Plain">apps</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pingus</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">x11</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pulseaudio</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once again: build, install, and run&hellip; et voilà! Is it just me, or was that surprisingly painless? Of course, not all applications live such isolated lives. Make note that the x11 interface is supposed to be a transitional interface, meaning that we would rather our app fully transition to Mir or some alternative. To go a step further with this snap, we could create a <code>snapcraft.yaml</code> to build from source to get the absolute latest version of our app. At this point, we can change our <code>grade</code> property to <code>stable</code> and feel good about something that we could push to the store for review.</p>

<p><em>Any code you see here is free software. Find the project here: <a href="https://github.com/larryprice/pingus-snap">https://github.com/larryprice/pingus-snap</a></em></p>
</div>
  
  


<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
></script>
<ins
  class="adsbygoogle"
  style="display: block; text-align: center"
  data-ad-layout="in-article"
  data-ad-format="fluid"
  data-ad-client="ca-pub-6961096698495477"
  data-ad-slot="4703525590"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/07/creating-a-snap-from-existing-deb-packages/">Building Snaps From Archived Packages</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-07T22:10:08-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:10 pm</span></time>
        
           | <a href="/blog/2016/12/07/creating-a-snap-from-existing-deb-packages/#disqus_thread"
             data-disqus-identifier="https://larry-price.com/blog/2016/12/07/creating-a-snap-from-existing-deb-packages/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you haven&rsquo;t heard, <a href="//snapcraft.io">snaps</a> are a new, modern packaging format made by the guys at Ubuntu. Snaps give every app a confined environment to live in, making desktops more secure and dependencies less of a hassle. One common way to create a snap is to simply use existing packages from the Ubuntu archives.</p>

<p>Let&rsquo;s try to create a snap for the game <a href="https://lgdb.org/game/pingus">pingus</a>. <code>pingus</code> is a great little Lemmings clone that we can easily convert to a snap. We&rsquo;ll start by installing the necessary dependencies for snap building (see <a href="//snapcraft.io/create/">the snapcraft website</a> for more):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt install snapcraft
</span></code></pre></td></tr></table></div></figure>


<p>Now we can initialize a project directory with snapcraft:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p pingus-snap <span class="o">&amp;&amp;</span> <span class="nb">cd </span>pingus-snap
</span><span class='line'><span class="nv">$ </span>snapcraft init
</span></code></pre></td></tr></table></div></figure>


<p><code>snapcraft init</code> creates the following sample file to give us an idea of what we&rsquo;ll need to provide.</p>

<figure class='code'><figcaption><span>snapcraft.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-snap-name</span> <span class="c1"># you probably want to &#39;snapcraft register &lt;name&gt;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;0.1&#39;</span> <span class="c1"># just for humans, typically &#39;1.2+git&#39; or &#39;1.3.2&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">summary</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Single-line elevator pitch for your amazing snap</span> <span class="c1"># 79 char long summary</span>
</span><span class='line'><span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>  <span class="no">This is my-snap&#39;s description. You have a paragraph or two to tell the</span>
</span><span class='line'>  <span class="no">most important story about your snap. Keep it under 100 words though,</span>
</span><span class='line'>  <span class="no">we live in tweetspace and your description wants to look good in the snap</span>
</span><span class='line'>  <span class="no">store.</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">grade</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">devel</span> <span class="c1"># must be &#39;stable&#39; to release into candidate/stable channels</span>
</span><span class='line'><span class="l-Scalar-Plain">confinement</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">devmode</span> <span class="c1"># use &#39;strict&#39; once you have the right plugs and slots</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">parts</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">my-part</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="c1"># See &#39;snapcraft plugins&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>Most of these values for our <code>pingus</code> snap should be obvious. The interesting markup here is in <code>parts</code>, which is where we&rsquo;ll describe how to build our snap. We&rsquo;ll start by taking advantage of the <code>nil</code> plugin to simply unpack the <code>pingus</code> deb from the archive. We define our list of debs to install in a list called <code>stage-packages</code>. We&rsquo;ll also define another section, <code>apps</code>, to tell <code>snapcraft</code> what binaries we want to be able to execute. In our case, this will just be the <code>pingus</code> command. Here&rsquo;s what my first draft looks like:</p>

<figure class='code'><figcaption><span>snapcraft.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;0.1&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">summary</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Free Lemmings(TM) clone</span>
</span><span class='line'><span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>    <span class="no">Pingus is a free clone of the popular Lemmings game.</span>
</span><span class='line'>    <span class="no">|</span>
</span><span class='line'>    <span class="no">Your goal is to guide a horde of penguins through a world full of obstacles</span>
</span><span class='line'>    <span class="no">and penguin traps to safety. Although penguins (unlike lemmings) are rather</span>
</span><span class='line'>    <span class="no">smart, they sometimes lack the necessary overview and now rely on you to</span>
</span><span class='line'>    <span class="no">save them.</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">grade</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">devel</span>
</span><span class='line'><span class="l-Scalar-Plain">confinement</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">devmode</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">parts</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">archives</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nil</span>
</span><span class='line'>    <span class="l-Scalar-Plain">stage-packages</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">apps</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pingus</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">usr/games/pingus</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nice, right? Building and installing our snap is easy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>snapcraft
</span><span class='line'><span class="nv">$ </span>sudo snap install --devmode pingus_0.1_amd64.snap
</span><span class='line'>pingus 0.1 installed
</span></code></pre></td></tr></table></div></figure>


<p>We used <code>devmode</code> here because our app will be running unconfined (a topic for another blog post). Now, for the moment of truth! The snap tools automatically put our new app in <code>PATH</code>, so we can just run <code>pingus</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pingus
</span><span class='line'>/snap/pingus/x2/usr/games/pingus: 2: <span class="nb">exec</span>: /usr/lib/games/pingus/pingus: not found
</span></code></pre></td></tr></table></div></figure>


<p>¡Ay, caramba! We&rsquo;ve run into a fairly common issue while snapping legacy software: <strong>hardcoded paths</strong>. Fortunately, the corresponding <code>pingus</code> executable is very simple. It&rsquo;s trying to execute a command living in <code>/usr/lib/games/pingus</code>, which is not in our snap&rsquo;s <code>PATH</code>. The easiest way to fix this is to fix the <code>pingus</code> executable. Since we don&rsquo;t want to spend time modifying the upstream to use a relative path, we can create our own version of the <code>pingus</code> wrapper locally and copy it into our snap. The only change to this new wrapper will be prepending the snap&rsquo;s install path <code>$SNAP</code> to the absolute paths:</p>

<figure class='code'><figcaption><span>pingus.wrapper</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nb">exec</span> <span class="nv">$SNAP</span>/usr/lib/games/pingus/pingus --datadir <span class="nv">$SNAP</span>/usr/share/games/pingus/data <span class="nv">$@</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can update our yaml file with a new part called <code>env</code> which will use the <code>dump</code> plugin to copy our wrapper file into the snap. We&rsquo;ll also update our command to call the wrapper:</p>

<figure class='code'><figcaption><span>snapcraft.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">parts</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">archives</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nil</span>
</span><span class='line'>    <span class="l-Scalar-Plain">stage-packages</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pingus</span>
</span><span class='line'>  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">plugin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dump</span>
</span><span class='line'>    <span class="l-Scalar-Plain">organize</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">pingus.wrapper</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">usr/bin/pingus</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">apps</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pingus</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pingus</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you run <code>snapcraft</code> this time, the <code>env</code> part will be built. After performing another install, you can run <code>pingus</code>, and you should be greeted with one of the best Lemmings clones available! Because we&rsquo;re running unconfined in devmode, this all just works without any issues. I intend to write another blog post in the near future with the details on confining <code>pingus</code>, so look out for that soon. I may also go into detail on building more complex cases, such as building snaps from source and building custom plugins, or reviewing a case study such as the <code>libertine</code> snap.</p>

<p>For much, much more on snaps, be sure to visit <a href="//snapcraft.io/create/">snapcraft.io</a>. If you&rsquo;re looking for a published version of pingus as a snap, you can try <code>sudo snap install --devmode --beta pingus-game</code>, and you can run the game with <code>pingus-game.pingus</code>.</p>

<p><em>Source code available at <a href="https://github.com/larryprice/pingus-snap">https://github.com/larryprice/pingus-snap</a>.</em></p>
</div>
  
  


<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
></script>
<ins
  class="adsbygoogle"
  style="display: block; text-align: center"
  data-ad-layout="in-article"
  data-ad-format="fluid"
  data-ad-client="ca-pub-6961096698495477"
  data-ad-slot="4703525590"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/27/clean-package-building-with-pbuilder/">Clean Package Building With Pbuilder</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-27T21:50:00-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:50 pm</span></time>
        
           | <a href="/blog/2016/09/27/clean-package-building-with-pbuilder/#disqus_thread"
             data-disqus-identifier="https://larry-price.com/blog/2016/09/27/clean-package-building-with-pbuilder/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whether I&rsquo;m adding dependencies, updating package names, or creating new package spins, I always have issues testing my debian packages. Something will work locally, only to fail on jenkins under a clean environment. Fortunately, there&rsquo;s a nifty tool called <code>pbuilder</code> that exists to help out in these situations. <code>pbuilder</code> uses a chroot to set up a clean environment to build packages, and can even be used to build packages for systems with architectures different from your own.</p>

<p><em>Note: All code samples were originally written from a machine running Ubuntu 16.10 64-bit. Your mileage may vary.</em></p>

<h3>Clean builds for current distro</h3>

<p>Given a typical debian-packaged project with a <code>debian</code> directory (<code>control</code>, <code>rules</code>, <code>.install</code>), you can use <code>debuild</code> to build a package from your local environment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>my-project
</span><span class='line'><span class="nv">$ </span>debuild
</span><span class='line'>...
</span><span class='line'><span class="nv">$ </span>ls ../*.deb
</span><span class='line'>my-project.deb
</span></code></pre></td></tr></table></div></figure>


<p>This works pretty well for sanity checks, but sometimes knowing your sane just isn&rsquo;t quite enough. My development environment is filled with libraries and files installed in all kinds of weird ways and in all kinds of strange places, so there&rsquo;s a good chance packages built successfully on my machine may not work on everyone&rsquo;s machine. To solve this, I can install <code>pbuilder</code> and set up my first chroot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="c"># install pbuilder and its dependencies</span>
</span><span class='line'><span class="nv">$ </span>sudo apt-get install pbuilder debootstrap devscripts
</span><span class='line'><span class="nv">$ </span><span class="c"># create a chroot for your current distro with build-essential pre-installed</span>
</span><span class='line'><span class="nv">$ </span>sudo pbuilder create --debootstrapopts --variant<span class="o">=</span>buildd
</span></code></pre></td></tr></table></div></figure>


<p>Since I use <code>debuild</code> pretty frequently, I also rely on <code>pdebuild</code> which performs <code>debuild</code> inside of the clean chroot environment, temporarily installing the needed dependencies listed in the <code>control</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>my-project
</span><span class='line'><span class="nv">$ </span>pdebuild
</span><span class='line'><span class="nv">$ </span>ls /var/cache/pbuilder/result/*.deb
</span><span class='line'>my-project.deb
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively, I could create the <code>.dsc</code> file and then use <code>pbuilder</code> to create the package from there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="c"># generate a dsc file however you like</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>my-project
</span><span class='line'><span class="nv">$ </span>bzr-builddeb -- -us -uc
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ..
</span><span class='line'><span class="nv">$ </span><span class="c"># use pbuilder to create package</span>
</span><span class='line'><span class="nv">$ </span>sudo pbuilder build my-project.dsc
</span><span class='line'><span class="nv">$ </span>ls /var/cache/pbuilder/result/*.deb
</span><span class='line'>my-project.deb
</span></code></pre></td></tr></table></div></figure>


<h3>Clean cross builds</h3>

<p>Let&rsquo;s say that you need to build for an older distribution of Ubuntu on a weird architecture. For this example, let&rsquo;s say <code>vivid</code> with <code>armhf</code>. We can use <code>pbuilder-dist</code> to verify and build our packages for other distros and architectures:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="c"># create the chroot, once again with build-essential pre-installed</span>
</span><span class='line'><span class="nv">$ </span>pbuilder-dist vivid armhf create --debootstrapopts --variant<span class="o">=</span>buildd
</span><span class='line'><span class="nv">$ </span><span class="c"># the above command could take a while, but once it&#39;s finished</span>
</span><span class='line'><span class="nv">$ </span><span class="c"># we can attempt to build our package using a .dsc file</span>
</span><span class='line'><span class="nv">$ </span>pbuilder-dist vivid armhf build my-project-dsc
</span><span class='line'><span class="nv">$ </span>ls ~/pbuilder/vivid-armhf_result/*.deb
</span><span class='line'>my-project.deb
</span></code></pre></td></tr></table></div></figure>


<h3>Custom, persistent chroot changes</h3>

<p>In some cases, you may need to enable other archives or install custom software in your chroot. In the case of our vivid-armhf chroot, let&rsquo;s add the <a href="https://launchpad.net/~ci-train-ppa-service/+archive/ubuntu/stable-phone-overlay">stable-overlay ppa</a> which updates the outdated vivid with some more modern versions of packages.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="c"># login to our vivid-armhf chroot, and save state when we&#39;re finished</span>
</span><span class='line'><span class="nv">$ </span><span class="c"># if --save-after-login is omitted, a throwaway chroot will be used</span>
</span><span class='line'><span class="nv">$ </span>pbuilder vivid armhf login --save-after-login
</span><span class='line'><span class="o">(</span>chroot<span class="o">)</span> <span class="nv">$ </span><span class="c"># install the package container add-apt-repository for convenience</span>
</span><span class='line'><span class="o">(</span>chroot<span class="o">)</span> <span class="nv">$ </span>apt install software-properties-common
</span><span class='line'><span class="o">(</span>chroot<span class="o">)</span> <span class="nv">$ </span>add-apt-repository ppa:ci-train-ppa-service/stable-phone-overlay
</span><span class='line'><span class="o">(</span>chroot<span class="o">)</span> <span class="nv">$ </span><span class="nb">exit</span>
</span><span class='line'><span class="nv">$ </span><span class="c"># update packages in the chroot</span>
</span><span class='line'><span class="nv">$ </span>pbuilder-dist vivid armhf update
</span></code></pre></td></tr></table></div></figure>


<p><code>pbuilder</code> and chroots are powerful tools in the world of packaging and beyond. There are scripting utilities, as well as pre- and post-build hooks which can customize your builds. There are ways to speed up clean builds using local caches or other &ldquo;cheats&rdquo;. You could use the throwaway terminal abilities to create and destroy tiny worlds as you please. All of this is very similar to the utility which comes from using docker and lxc, though the underlying &ldquo;container&rdquo; is quite a bit different. Using <code>pbuilder</code> seems to have a much lower threshold for setup, so I prefer it over docker for clean build environments, but I believe docker/lxc to be the better tool for managing the creation of consistent virtual environments.</p>

<p><em>Further reading:</em></p>

<p><a href="https://wiki.ubuntu.com/PbuilderHowto">Pbuilder HowTo on the Ubuntu wiki</a>
<a href="https://wiki.debian.org/PbuilderTricks">Pbuilder tricks from the debian wiki</a></p>
</div>
  
  


<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
></script>
<ins
  class="adsbygoogle"
  style="display: block; text-align: center"
  data-ad-layout="in-article"
  data-ad-format="fluid"
  data-ad-client="ca-pub-6961096698495477"
  data-ad-slot="4703525590"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/07/getting-started-with-python-mocks-from-a-c-plus-plus-perspective/">Getting Started With Python Mocking and Patching</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-07T23:00:09-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>11:00 pm</span></time>
        
           | <a href="/blog/2016/09/07/getting-started-with-python-mocks-from-a-c-plus-plus-perspective/#disqus_thread"
             data-disqus-identifier="https://larry-price.com/blog/2016/09/07/getting-started-with-python-mocks-from-a-c-plus-plus-perspective/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I currently write a lot of python and C++. Although I religiously unit test my C++ code, I&rsquo;m a bit ashamed to say that I haven&rsquo;t had much experience with python unit testing until recently. You know how it is - python is one of those interpreted languages, you mostly use it to do quick hacks, it doesn&rsquo;t <em>need</em> tests. Until you&rsquo;ve written your entire D-Bus service using python, and every time you make a code change <em>a literal python</em> appears on the screen to crash your computer. So I&rsquo;ve started writing a bunch of tests and found (as expected) a tangled mess of dependencies and system calls.</p>

<p>In many C-like languages, you can fix most of your dependency problems with <a href="https://stackoverflow.com/questions/346372/whats-the-difference-between-faking-mocking-and-stubbing#answer-346440">The Big Three</a>: mocks, fakes, and stubs. A fake is an actual implementation of an interface used for non-production environments, a stub is an implementation of an interface returning a pre-conceived result, and a mock is a wrapper around an interface allowing a programmer to accurately map what actions were performed on the object. In C-like languages, you use <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> to give our classes fakes, mocks, or stubs instead of real objects during testing.</p>

<p>The good news is that we can also use dependency injection in python! However, I found that relying solely on dependency injection would pile on more dependencies than I wanted and was not going to work to cover all my system calls. But python is a dynamic language. In python, you can literally change the definition of a class inside of another class. We call this operation <strong>patch</strong> and you can use it extensively in testing to do some pretty cool stuff.</p>

<h3>Code Under Test</h3>

<p>Let&rsquo;s define some code to test. For all of these examples, I&rsquo;ll be using python3.5.2 with the <a href="https://docs.python.org/3/library/unittest.html">unittest</a> and <a href="https://docs.python.org/3/library/unittest.mock.html">unittest.mock</a> libs on Ubuntu 16.10. You can the final versions of these code samples <a href="https://github.com/larryprice/python-mocks-blog-post">on github</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">WorkerStrikeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    A Worker will work a full 40 hour week and then go on strike. Each time</span>
</span><span class='line'><span class="sd">    a Worker works, they work a random amount of time between 1 and 40.</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">hours_worked</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">timesheet</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">hours_worked</span> <span class="o">+=</span> <span class="n">timesheet</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hours_worked</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
</span><span class='line'>            <span class="k">raise</span> <span class="n">WorkerStrikeException</span><span class="p">(</span><span class="s">&quot;This worker is picketing&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">timesheet</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Boss</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    A Boss makes profit using workers. Bosses squeeze 1000 monies out of a</span>
</span><span class='line'><span class="sd">    Worker for each hour worked. Workers on strike are instantly replaced.</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">profit</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">make_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">profit</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span>
</span><span class='line'>        <span class="k">except</span> <span class="n">WorkerStrikeException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">()</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">profit</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span>
</span><span class='line'>        <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profit</span>
</span></code></pre></td></tr></table></div></figure>


<p>These are two simple classes (and a custom <code>Exception</code>) that we&rsquo;ll use to demonstrate unit testing in python. The first class, <code>Worker</code>, will work a maximum of 40 hours per week before picketing it&rsquo;s corporation. Each time <code>work</code> is called, the <code>Worker</code> will work a random number of hours. The <code>Boss</code> class takes in a <code>Worker</code> object, which it uses as it performs <code>make_profit</code>. The profit is determined by the number of hours worked multiplied by 1000. When the worker starts picketing, the <code>Boss</code> will hire a new <code>Worker</code> to take their place. So it goes.</p>

<h3>Mocking the Worker Class</h3>

<p>Our goal is to fully test the <code>Boss</code> class. We&rsquo;ve left ourselves a dependency to inject in the <code>__init__</code> method, so we could start there. We&rsquo;ll mock the <code>Worker</code> and pass it into the <code>Boss</code> initializer. We&rsquo;ll then set up the <code>Worker.work</code> method to always return a known number so we can test the functionality of <code>make_profit</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">unittest.mock</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">corp</span> <span class="kn">import</span> <span class="n">work</span>  <span class="c"># your impl file</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">BossTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">test_profit_adds_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">worker</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">create_autospec</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">Worker</span><span class="p">)</span>
</span><span class='line'>        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">8</span>
</span><span class='line'>        <span class="n">boss</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">Boss</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">8000</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">16000</span><span class="p">)</span>
</span><span class='line'>        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">26000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span>
</span><span class='line'>            <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
</span><span class='line'>        <span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>To run this test, use the command <code>python3 -m testtools.run test</code>, where <code>test</code> is the name of your test file without the <code>.py</code>.</p>

<p>One curiosity here is <code>unittest.mock.create_autospec</code>. Python will also let you directly create a <code>Mock</code>, which will absorb all attribute calls regardless of whether they are defined, and <code>MagicMock</code>, which is like <code>Mock</code> except it also mocks magic methods. <code>create_autospec</code> will create a mock with all of the defined attributes of the given class (in our case <code>work.Worker</code>), and raise an Exception when the attribute is not defined on the specced class. This is really handy, and eliminates the possibility of tests &ldquo;accidentally passing&rdquo; because they are calling default attributes defined by the generic <code>Mock</code> or <code>MagicMock</code> initializers.</p>

<p>We set the return value of the <code>work</code> function with <code>return_value</code>, and we can change it on a whim if we so desire. We then use <code>assertEqual</code> to verify the numbers are crunching as expected. One further thing I&rsquo;ve shown here is <code>assert_has_calls</code>, a mock assertion to verify that <code>work</code> was called 3 times on our mock method.</p>

<p>You may also note that we subclassed <code>TestCase</code> to enable running this class as part of our unit testing framework with the special <code>__main__</code> method definition at the bottom of the file.</p>

<h3>Patching the Worker Class</h3>

<p>Although our first test demonstrates how to <code>make_profit</code> with a happy worker, we also need to verify how the <code>Boss</code> handles workers on strike. Unforunately, the <code>Boss</code> class creates his own <code>Worker</code> internally after learning they can&rsquo;t trust the <code>Worker</code> we gave them in the initializer. We want to create consistent tests, so we can&rsquo;t rely on the random numbers generated by <code>randint</code> in <code>Worker.work</code>. This means we can&rsquo;t just depend on dependency injection to make these tests pass!</p>

<p>At this point we have two options: we can patch the <code>Worker</code> class or we can patch the <code>randint</code> function. Why not both! As luck would have it, there are a few ways to use <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch"><code>patch</code></a>, and we can explore a couple of these ways in our two example tests.</p>

<p>We&rsquo;ll patch the <code>randint</code> function using a method decorator. Our intent is to make <code>randint</code> return a static number every time, and then verify that profits keep booming even as we push workers past their limit.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@unittest.mock.patch</span><span class="p">(</span><span class="s">&#39;corp.work.randint&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">test_profit_adds_up_despite_turnover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">randint</span><span class="p">):</span>
</span><span class='line'>    <span class="n">boss</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">Boss</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">Worker</span><span class="p">())</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">20000</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">40000</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">60000</span><span class="p">)</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">80000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">randint</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span>
</span><span class='line'>        <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
</span><span class='line'>        <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>    <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>When calling <code>patch</code>, you must describe the namespace relative to the module you&rsquo;re importing. In our case, we&rsquo;re using <code>randint</code> in the <code>corp.work</code> module, so we use <code>corp.work.randint</code>. We define the <code>return_value</code> of <code>randint</code> to simply be 20. A fine number of hours per day to work an employee, according to the <code>Boss</code>. <code>patch</code> will inject a parameter into the test representing an automatically created mock that will be used in the patch, and we use that to assert that our calls were all made the way we expected.</p>

<p>Since we know the inner workings of the <code>Worker</code> class, we know that this test exercised our code by surpassing a 40-hour work week for our poor <code>Worker</code> and causing the <code>WorkerStrikeException</code> to be raised. In doing so, we&rsquo;re depending on the <code>Worker</code>/<code>Boss</code> implementation to stay in-sync, which is a dangerous assumption. Let&rsquo;s explore patching the <code>Worker</code> class instead.</p>

<p>To spice things up, we&rsquo;ll use the <code>ContextManager</code> syntax when we patch the <code>Worker</code> class. We&rsquo;ll create one mock <code>Worker</code> outside of the context to use for dependency injection, and we&rsquo;ll use this mock to <code>raise</code> the <code>WorkerStrikeException</code> as a side effect of <code>work</code> being called too many times. Then we&rsquo;ll patch the <code>Worker</code> class for newly created instances to return a known timesheet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">test_profit_adds_up_despite_strikes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="n">worker</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">create_autospec</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">Worker</span><span class="p">)</span>
</span><span class='line'>    <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">12</span>
</span><span class='line'>    <span class="n">boss</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">Boss</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&#39;corp.work.Worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">MockWorker</span><span class="p">:</span>
</span><span class='line'>        <span class="n">scrub</span> <span class="o">=</span> <span class="n">MockWorker</span><span class="o">.</span><span class="n">return_value</span>
</span><span class='line'>        <span class="n">scrub</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">4</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">12000</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">24000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">WorkerStrikeException</span><span class="p">(</span><span class="s">&#39;Faking a strike!&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">28000</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">boss</span><span class="o">.</span><span class="n">make_profit</span><span class="p">(),</span> <span class="mi">32000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span>
</span><span class='line'>            <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
</span><span class='line'>        <span class="p">])</span>
</span><span class='line'>        <span class="n">scrub</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span>
</span><span class='line'>            <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
</span><span class='line'>        <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>After the first <code>Worker</code> throws a <code>WorkerStrikeException</code>, the second <code>Worker</code> (scrub) comes in to replace them. In patching the <code>Worker</code>, we are able to more accurately describe the behavior of <code>Boss</code> regardless of the implementation details behind <code>Worker</code>.</p>

<h3>A Non-Political Conclusion</h3>

<p>I&rsquo;m not saying this is the best way to go about unit testing in python, but it is an option that should help you get started unit testing legacy code. There are certainly those who see this level of micromanaging mocks and objects as tedious, but there is be benefit to defining the way a class acts under exact circumstances. This was a contrived example, and your code may be a little bit harder to wrap with tests.</p>

<p>Now you can go get Hooked on Pythonics!</p>
</div>
  
  


<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
></script>
<ins
  class="adsbygoogle"
  style="display: block; text-align: center"
  data-ad-layout="in-article"
  data-ad-format="fluid"
  data-ad-client="ca-pub-6961096698495477"
  data-ad-slot="4703525590"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/24/running-x-applications-in-unity-8/">Maintaining X Applications in Unity 8</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-24T17:29:59-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>5:29 pm</span></time>
        
           | <a href="/blog/2016/08/24/running-x-applications-in-unity-8/#disqus_thread"
             data-disqus-identifier="https://larry-price.com/blog/2016/08/24/running-x-applications-in-unity-8/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The release of Ubuntu 16.10 Yakkety Yak in the coming months will bring about the public release of Unity 8 as a pre-installed desktop session (though not as the default session). It&rsquo;s been a long time coming, and there&rsquo;s a lot of new features which will break older applications. Canonical has unveiled <a href="http://snapcraft.io">snappy</a> as the preferred packaging system for Unity 8, but what about all those old deb packages?</p>

<p>There have been a few other good posts about X applications on Unity 8 including <a href="http://mhall119.com/2016/05/dogfooding-unity-8/">this one on dogfooding</a>, <a href="https://kylenubuntu.blogspot.no/2016/07/running-x-apps-on-ubuntu-devices.html">this one on Ubuntu Touch</a>, and <a href="https://bregmatter.wordpress.com/2016/07/04/x11-applications-and-unity-8/">this one on how it works under the covers</a>. This blog post is explicitly about Unity 8 on desktop using the Libertine CLI, though can be applied to most devices running Ubuntu Touch.</p>

<p><em>Disclaimer: I work for Canonical on one of the teams making all of this fancy stuff work.</em></p>

<h3>A (Very) Brief Explanation</h3>

<p>The toolchain we&rsquo;ll be relying on is called <code>libertine</code>, and it&rsquo;s essentially a wrapper around unprivileged LXC and chroot-based containers. We prefer to use LXC containers on newer OSes, but we must continue supporting chroot containers on many devices due to kernel limitations.</p>

<h3>What You&rsquo;ll Need</h3>

<p>For desktop Unity 8, you&rsquo;ll need the packages for <code>libertine</code>, <code>libertine-tools</code>, and <code>lxc</code> to get started. This will install a CLI and GUI for maintaining Libertine containers and applications.</p>

<p>If you&rsquo;re running Wily or newer, you can just run the following in your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt install libertine
</span></code></pre></td></tr></table></div></figure>


<p>Otherwise, you&rsquo;ll need to add the stable overlay PPA first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo add-apt-repository ppa:ci-train-ppa-service/stable-phone-overlay
</span><span class='line'><span class="nv">$ </span>sudo apt-get update
</span><span class='line'><span class="nv">$ </span>sudo apt-get install libertine
</span></code></pre></td></tr></table></div></figure>


<h3>The GUI</h3>

<p>At this point, if you&rsquo;re on desktop you can open up the GUI which will guide you through creating a new container and installing applications. Search the Dash (or Apps scope) for <code>libertine</code> and, given that we haven&rsquo;t pushed a buggy version recently, you&rsquo;ll be presented with a Qt application for maintaining containers. I highly recommend using the GUI, because then you are guaranteed not to be following out-of-date console commands.</p>

<p>&hellip;But maybe you prefer the terminal. Or maybe you&rsquo;re secretly SSH&rsquo;d into the target machine or Ubuntu Touch device and need to use the terminal. If so&hellip;</p>

<h3>The CLI</h3>

<p>The CLI we&rsquo;ll be using is <code>libertine-container-manager</code>. It has a <code>manpage</code>, a <code>--help</code> option, and autocomplete to help you out in a jam.</p>

<p>The first thing you&rsquo;ll want to do is create a container. There are a lot of options, but to create an optimal container for your current machine you only need to specify the <code>id</code> and <code>name</code> parameters:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>libertine-container-manager create --id desktopapps --name <span class="s2">&quot;Desktop Applications&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>A couple of things to note here: Your <code>id</code> must be unique and conform to the simple click name regex - this is what will identify your container on a system level. The <code>name</code> should be human-readable so you can easily identify what might be inside your container. If you don&rsquo;t specify a <code>name</code>, your <code>id</code> will be used. The CLI will likely ask you for a password to use in the container in case you ever need it. You can leave this blank if you&rsquo;re not concerned with that kind of thing.</p>

<p>At this point, a bunch of things should be happening in your terminal. This will pull a container image for your current distro and install all the requirements to get started maintaining and running X apps. This could take anywhere from a few minutes to the next hour depending on your network and disk speeds. Once you&rsquo;re done, you can use the <code>list</code> subcommand to list all installed containers (note you probably just have one at this point). If you ever want to delete your container, you can run <code>libertine-container-manager destroy -i desktopapps</code>.</p>

<p>Once that&rsquo;s finished, we can start installing apps. To find apps available, you can use the <code>search-cache</code> subcommand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>libertine-container-manager search-cache --id desktopapps --search-string <span class="s2">&quot;office&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will return a few strings from the apt-cache of the container with <code>id</code> &ldquo;desktopapps&rdquo; that match &ldquo;office&rdquo;. Now, if you want to install &ldquo;libreoffice&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>libertine-container-manager install-package --id desktopapps --package libreoffice
</span></code></pre></td></tr></table></div></figure>


<p>This will install the full libreoffice suite. Nice! Similarly, you can use the <code>remove-package</code> subcommand to remove applications. Don&rsquo;t remember what apps you&rsquo;ve installed? Use the <code>list-apps</code> command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>libertine-container-manager list-apps --id desktopapps
</span></code></pre></td></tr></table></div></figure>


<p>Maybe you&rsquo;re an avid Steam for Linux gamer and want to try to get some games working. Since Steam still only comes in a 32-bit binary, you&rsquo;ll need to enable the multiarch repos, and then you can just install Steam like any other app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>libertine-container-manager configure --id desktopapps --multiarch <span class="nb">enable</span>
</span><span class='line'>...
</span><span class='line'><span class="nv">$ </span>libertine-container-manager install-package --id desktopapps --package steam
</span></code></pre></td></tr></table></div></figure>


<p>Steam will ask you to agree to their user agreement from the command line, which you should be able to do easily. If you need to use the <code>readline</code> frontend for dpkg, you can append <code>--readline</code> to the <code>install-package</code> command to enable it.</p>

<p>There are many other commands to explore to maintain your container, but for now I&rsquo;ll let you check the manpage or open the GUI to explore further.</p>

<h3>Running Apps</h3>

<p>Now that you&rsquo;ve installed some apps, you probably want to run them. You can install the Libertine Scope, which will allow you to peruse your installed apps in a Unity 8 session. You can either install it from the App Store on a device (search for &ldquo;Desktop Apps Scope&rdquo;) or through <code>apt</code> on desktop with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt install libertine-scope
</span></code></pre></td></tr></table></div></figure>


<p>In a Unity 8 session, you can now find the scope and click on apps to run them. Note that there are many apps which still don&rsquo;t work, such as those requiring a terminal or <code>sudo</code>; consider these a work in progress.</p>

<h3>The Future</h3>

<p>I&rsquo;ve been toiling away the past few weeks getting a scope ready which can be used explicitly to install/remove X apps in Unity 8, like the current Ubuntu Software Center (or app store on Touch devices). This scope should be available anywhere the libertine scope is available, meaning that it will alleviate a lot of the pain associated with installing/removing apps for a large chunk of users. Using the Libertine GUI or Libertine CLI will still allow for much more customization, but those tools are largely designed with power users in mind.</p>

<p>Are you able to get libertine working on your system? Can you launch X applications to your heart&rsquo;s content? Let me know in the comments!</p>
</div>
  
  


<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
></script>
<ins
  class="adsbygoogle"
  style="display: block; text-align: center"
  data-ad-layout="in-article"
  data-ad-format="fluid"
  data-ad-client="ca-pub-6961096698495477"
  data-ad-slot="4703525590"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <span class="social-media-bar">
    <a href="https://github.com/larryprice" title="Github" alt="github profile"><img src="/images/icon_github.png" class="social-media-icon" /></a>
    <!-- <a href="https://launchpad.net/~larryprice" title="Launchpad" alt="launchpad profile"><img src="/images/icon_lp.png" class="social-media-icon" /></a> -->
    <a href="https://www.patreon.com/larryprice" title="Patreon" alt="patreon profile"><img src="/images/icon_patreon.png" class="social-media-icon" /></a>
    <a href="https://twitter.com/larryrprice" title="Twitter" alt="Twitter profile"><img src="/images/icon_twitter.png" class="social-media-icon" /></a>
    <a href="https://www.linkedin.com/pub/larry-price/3a/630/47b" title="LinkedIn" alt="LinkedIn profile"><img src="/images/icon_linkedin.png" class="social-media-icon" /></a>
    <a href="mailto:larry@larry-price.com" title="Email" alt="email me"><img src="/images/icon_email.png" class="social-media-icon" /></a>
  </span>
</section>
<section>
  <h1>void* Larry</h1>
  <p>I'm a codeslinger debugging from the mean streets of Champaign-Urbana, IL. Welcome to my blog, where I'll tell the tales of wondrous things I discover in the digital jungle.</p>
</section>
<section>
  <h1>Patreon</h1>
  <p>Like what I'm doing? <b><a href="https://www.patreon.com/larryprice">Fund me on Patreon</a></b> so I can keep doing it!</p>
</section>
<section>
  <h1>Go for Web Development</h1>
  <p><strong><a href="https://www.packtpub.com/web-development/go-web-development-video" target="blank">Go for Web Development</a></strong> is an online video series designed by me where you'll follow along to build a personal library app in Go. You'll start with a blank slate but quickly learn to take advantage of popular libraries such as gorilla/mux, negroni, gorp, ace, and bcrypt.</p>
</section>
<section>
  <h1>FOSDEM 2017</h1>
  <p>In 2017, I had the opportunity to give a short talk at FOSDEM in Brussels. I even <strong><a href="https://www.youtube.com/watch?v=FX1fSTOU8Ao&t=1152s" target="blank">recorded an at-home experience</a></strong> with higher quality audio and slides than the livestream.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/02/09/getting-started-with-react-hooks/">Getting Started With React Hooks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/27/notes-from-all-things-open-2018/">Notes From All Things Open 2018</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/27/how-to-use-getderivedstatefromprops-in-react-16-dot-3-plus/">How to Use getDerivedStateFromProps in React 16.3+</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/26/quick-start-to-vendor-go-dependencies-with-govendor/">Quick Start to Vendor Go Dependencies With Govendor</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/25/redirecting-to-your-main-site-with-heroku/">Redirecting to Your Main Site With Heroku</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/ads' style='font-size: 103.63636363636364%'>ads</a> <a href='/blog/categories/agile' style='font-size: 105.45454545454545%'>agile</a> <a href='/blog/categories/api' style='font-size: 101.81818181818181%'>api</a> <a href='/blog/categories/c-plus-plus' style='font-size: 107.27272727272727%'>c++</a> <a href='/blog/categories/capybara' style='font-size: 105.45454545454545%'>capybara</a> <a href='/blog/categories/css' style='font-size: 103.63636363636364%'>css</a> <a href='/blog/categories/cucumber' style='font-size: 107.27272727272727%'>cucumber</a> <a href='/blog/categories/database' style='font-size: 112.72727272727272%'>database</a> <a href='/blog/categories/dbus' style='font-size: 105.45454545454545%'>dbus</a> <a href='/blog/categories/docker' style='font-size: 107.27272727272727%'>docker</a> <a href='/blog/categories/foreman' style='font-size: 101.81818181818181%'>foreman</a> <a href='/blog/categories/foss' style='font-size: 103.63636363636364%'>foss</a> <a href='/blog/categories/git' style='font-size: 101.81818181818181%'>git</a> <a href='/blog/categories/gmock' style='font-size: 101.81818181818181%'>gmock</a> <a href='/blog/categories/go' style='font-size: 103.63636363636364%'>go</a> <a href='/blog/categories/golang' style='font-size: 118.18181818181819%'>golang</a> <a href='/blog/categories/gtest' style='font-size: 101.81818181818181%'>gtest</a> <a href='/blog/categories/hacks' style='font-size: 101.81818181818181%'>hacks</a> <a href='/blog/categories/haml' style='font-size: 101.81818181818181%'>haml</a> <a href='/blog/categories/heroku' style='font-size: 107.27272727272727%'>heroku</a> <a href='/blog/categories/html' style='font-size: 103.63636363636364%'>html</a> <a href='/blog/categories/html5' style='font-size: 101.81818181818181%'>html5</a> <a href='/blog/categories/internet' style='font-size: 101.81818181818181%'>internet</a> <a href='/blog/categories/javascript' style='font-size: 130.9090909090909%'>javascript</a> <a href='/blog/categories/linux' style='font-size: 110.9090909090909%'>linux</a> <a href='/blog/categories/mongo' style='font-size: 101.81818181818181%'>mongo</a> <a href='/blog/categories/mongodb' style='font-size: 105.45454545454545%'>mongodb</a> <a href='/blog/categories/mongoid' style='font-size: 105.45454545454545%'>mongoid</a> <a href='/blog/categories/mongolab' style='font-size: 101.81818181818181%'>mongolab</a> <a href='/blog/categories/mongoose' style='font-size: 101.81818181818181%'>mongoose</a> <a href='/blog/categories/mvc' style='font-size: 101.81818181818181%'>mvc</a> <a href='/blog/categories/nodejs' style='font-size: 109.0909090909091%'>nodejs</a> <a href='/blog/categories/non-technical' style='font-size: 160.0%'>non-technical</a> <a href='/blog/categories/nosql' style='font-size: 101.81818181818181%'>nosql</a> <a href='/blog/categories/nvm' style='font-size: 101.81818181818181%'>nvm</a> <a href='/blog/categories/octopress' style='font-size: 101.81818181818181%'>octopress</a> <a href='/blog/categories/ollert' style='font-size: 125.45454545454545%'>ollert</a> <a href='/blog/categories/openshift' style='font-size: 101.81818181818181%'>openshift</a> <a href='/blog/categories/php' style='font-size: 101.81818181818181%'>php</a> <a href='/blog/categories/pokephile' style='font-size: 105.45454545454545%'>pokephile</a> <a href='/blog/categories/pony' style='font-size: 101.81818181818181%'>pony</a> <a href='/blog/categories/python' style='font-size: 107.27272727272727%'>python</a> <a href='/blog/categories/qt' style='font-size: 101.81818181818181%'>qt</a> <a href='/blog/categories/rails' style='font-size: 101.81818181818181%'>rails</a> <a href='/blog/categories/react' style='font-size: 101.81818181818181%'>react</a> <a href='/blog/categories/reactjs' style='font-size: 105.45454545454545%'>reactjs</a> <a href='/blog/categories/remote' style='font-size: 107.27272727272727%'>remote</a> <a href='/blog/categories/retro' style='font-size: 112.72727272727272%'>retro</a> <a href='/blog/categories/rspec' style='font-size: 101.81818181818181%'>rspec</a> <a href='/blog/categories/ruby' style='font-size: 130.9090909090909%'>ruby</a> <a href='/blog/categories/rvm' style='font-size: 105.45454545454545%'>rvm</a> <a href='/blog/categories/sass' style='font-size: 101.81818181818181%'>sass</a> <a href='/blog/categories/satire' style='font-size: 101.81818181818181%'>satire</a> <a href='/blog/categories/sendgrid' style='font-size: 101.81818181818181%'>sendgrid</a> <a href='/blog/categories/sep-blog-battle' style='font-size: 114.54545454545455%'>sep-blog-battle</a> <a href='/blog/categories/sequel' style='font-size: 101.81818181818181%'>sequel</a> <a href='/blog/categories/sinatra' style='font-size: 116.36363636363636%'>sinatra</a> <a href='/blog/categories/snappy' style='font-size: 105.45454545454545%'>snappy</a> <a href='/blog/categories/testing' style='font-size: 114.54545454545455%'>testing</a> <a href='/blog/categories/trello' style='font-size: 114.54545454545455%'>trello</a> <a href='/blog/categories/twitter-bootstrap' style='font-size: 103.63636363636364%'>twitter-bootstrap</a> <a href='/blog/categories/ubuntu' style='font-size: 118.18181818181819%'>ubuntu</a> <a href='/blog/categories/unity' style='font-size: 101.81818181818181%'>unity</a> <a href='/blog/categories/upstart' style='font-size: 101.81818181818181%'>upstart</a> <a href='/blog/categories/web' style='font-size: 141.8181818181818%'>web</a> <a href='/blog/categories/write-ups' style='font-size: 143.63636363636363%'>write-ups</a> <a href='/blog/categories/xml' style='font-size: 101.81818181818181%'>xml</a> </span>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/larryprice">@larryprice</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'larryprice',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <style>
    .sidebar-ad { width: 280px; height: 280px; }}
    @media(min-width: 375px) { .sidebar-ad { width: 350px; height: 90px; } }
    @media(min-width: 475px) { .sidebar-ad { width: 450px; height: 90px; } }
    @media(min-width: 575px) { .sidebar-ad { width: 550px; height: 90px; } }
    @media(min-width: 675px) { .sidebar-ad { width: 650px; height: 90px; } }
    @media(min-width: 750px) { .sidebar-ad { width: 200px; height: 200px; } }
    @media(min-width: 768px) { .sidebar-ad { width: 210px; height: 210px; } }
    @media(min-width: 1280px) { .sidebar-ad { width: 260px; height: 260px; } }
  </style>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Sidebar Ad -->
    <ins class="adsbygoogle sidebar-ad"
         style="display:inline-block"
         data-ad-client="ca-pub-6961096698495477"
         data-ad-slot="8892886941"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <center>
	  Copyright &copy; 2020 - Larry Price -
	  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span><br/>
	  Note: Views and opinions expressed belong solely to the author and do not represent the views of the any other person or company.
	</center>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'larryprice';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
