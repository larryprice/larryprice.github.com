<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: rspec | Larry Price]]></title>
  <link href="https://larry-price.com/blog/categories/rspec/atom.xml" rel="self"/>
  <link href="https://larry-price.com/"/>
  <updated>2018-02-19T12:50:34-06:00</updated>
  <id>https://larry-price.com/</id>
  <author>
    <name><![CDATA[Larry Price]]></name>
    <email><![CDATA[larry@larry-price.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Moving from the MongoDB Ruby Driver to Mongoid]]></title>
    <link href="https://larry-price.com/blog/2013/01/05/moving-from-the-mongodb-ruby-driver-to-mongoid/"/>
    <updated>2013-01-05T20:04:00-06:00</updated>
    <id>https://larry-price.com/blog/2013/01/05/moving-from-the-mongodb-ruby-driver-to-mongoid</id>
    <content type="html"><![CDATA[<p>This is Part 2 in a multi-part series to detail the creation of a &ldquo;simple&rdquo; project combining <a href="http://www.ruby-lang.org/">Ruby</a>, <a href="http://www.mongodb.org/">MongoDB</a>, <a href="http://rspec.info/">RSpec</a>, <a href="http://www.sinatrarb.com/">Sinatra</a>, and <a href="https://github.com/jnicklas/capybara">Capybara</a> in preperation for a larger-scale side project set to begin January 2013. For more in this series, see the <a href="/blog/categories/pokephile">Pokephile category</a>. Part 2 details refactoring code using the MongoDB Ruby driver to use Mongoid. The code for this side-project is located <a href="https://github.com/larryprice/Pokephile">on Github</a>.</p>

<h3>What I&rsquo;ve Done</h3>

<p>In a <a href="/blog/2013/01/05/schemaless-databases-with-ruby-and-mongodb/">previous post</a>, I described creating a class that would populate a database with data scraped from the internet. I used the MongoDB Ruby driver to accomplish this. However, using the driver can be laborious and there are simpler ways. In this post, I&rsquo;m going to refactor the Populater class to use Mongoid.</p>

<h3>Mongoid</h3>

<p><a href="http://http://mongoid.org/en/mongoid/index.html">Mongoid</a> (pronounced mann-goyd) is an Object-Document Wrapper for Ruby. Using mongoid abstracts some of the database operations that must be performed when using the MongoDB Ruby driver. It comes in handy when using models in an MVC application. To install the Mongoid gem:</p>

<pre><code>sudo gem install mongoid
</code></pre>

<h3>Refactoring</h3>

<p>In populater.rb, we only inserted one structure of document into our &ldquo;pokemons&rdquo; collection. That makes this a great opportunity to use Mongoid. We remember that there were four fields in our document: number (string), name (string), image link (string), and types (array). Knowing this, we can create a model for this data:</p>

<pre><code class="ruby project/pokemon.rb">require 'mongoid'

class Pokemon
    include Mongoid::Document

    field :number, type: String
    field :name, type: String
    field :types, type: Array
    field :image, type: String
end
</code></pre>

<p>And that&rsquo;s it for our model. Although we specified the types in this case, it&rsquo;s not necessary if we want a looser definition of our model. Here&rsquo;s how we change our implementation file:</p>

<pre><code class="ruby project/tools/populate/populater.rb">#require 'mongo' #deleted
require_relative '../../pokemon' #added
require 'nokogiri'
require 'open-uri'

class Populater
    #def initialize(db_name) #removed
  def initialize #added
      #@col = Mongo::Connection.new.db(db_name)["pokemons"] #deleted
      #@col.remove #deleted
      Pokemon.delete_all #added
      @data = Nokogiri::HTML(open("http://pokemon.wikia.com/wiki/List_of_Pok%C3%A9mon"))
  end

  def add_pokemon(num_to_add)
    @data.xpath("//table[@class='wikitable sortable']/tr").each do |row|
        break if num_to_add &lt;= 0
        dex_num = row.at_xpath('td/text()').to_s.strip
        next if dex_num.nil? || dex_num.empty?
        dex_name = row.at_xpath('td[2]/a/text()').to_s.strip

        unless dex_num == "000"
            type_1 = row.at_xpath('td[4]/a/span/text()').to_s.strip
            type_2 = row.at_xpath('td[5]/a/span/text()').to_s.strip || row.at_xpath('td[5]/text()').to_s.strip
            image_link = "http://img.pokemondb.net/artwork/#{dex_name.downcase}.jpg"
        else
            type_1 = row.at_xpath('td[4]/text()').to_s.strip
            type_2 = row.at_xpath('td[5]/text()').to_s.strip
            image_link = "images/missingo.png"
        end

        types = Array.new
        types &lt;&lt; type_1 unless type_1.nil? || type_1.empty?
        types &lt;&lt; type_2 unless type_2.nil? || type_2.empty?

        #@col.insert({:number =&gt; dex_num, :name =&gt; dex_name, :types =&gt; types, :image =&gt; image_link}) #deleted
        Pokemon.create {:number =&gt; dex_num, :name =&gt; dex_name, :types =&gt; types, :image =&gt; image_link} #added

        num_to_add -= 1
    end
  end
end
</code></pre>

<p>That one&rsquo;s easy. We deleted four lines and added 3. However, now you can see that the Populater does not have to deal with connecting to the database, it only has to know what model it wants to modify. So we&rsquo;ve removed some complexity from this file by no longer requiring the database name on initialization. However, that means that someone else has to be in charge of setting up the initial connection. In the overlying project, we want that someone else to be a controller. In our tests, we want that someone else to be our test file. So let&rsquo;s do it. We&rsquo;re going to start by adding a config section in our before:all block.</p>

<pre><code class="ruby project/tools/test/spec/populater_spec.rb">require_relative '../../populate/populater'
#require 'mongo' #removed
require 'mongoid' #added
require_relative '../../../pokemon'

describe Populater do
    before:all do
        Mongoid.configure do |config| #added
            config.connect_to 'test' #added
        end # added
        #@col = Mongo::Connection.new.db('test')["pokemons"] # removed
    end
    ...
end
</code></pre>

<p>In doing this, we&rsquo;ve set up any of our document models to use the &lsquo;test&rsquo; database. Now we go through each test and replace the Mongo Ruby Driver syntax with Mongoid syntax, which is similar to Ruby&rsquo;s Array syntax.</p>

<pre><code class="ruby project/tools/test/spec/populater_spec.rb">...

describe Populater do
    ...
    before:each do
        #@populater = Populater.new('test') #removed
        @populater = Populater.new #added
    end

    describe "#new" do
        it "does not throw when creating instance" do
            #expect {Populater.new('test')}.to_not raise_error #removed
            expect {Populater.new}.to_not raise_error #added
        end

        it "takes one param and returns a Populater instance" do
            @populater.should be_an_instance_of Populater
        end

        it "empties pokemon collection" do
            #@col.insert({:test =&gt; "hi there"}) #removed
            #@col.find.count.should_not eql 0 #removed
            #Populater.new('test') #removed
            #@col.find.count.should eql 0 #removed
            Pokemon.create #added
            Pokemon.count.should eql 1 #added
            Populater.new #added
            Pokemon.count.should eql 0 #added
        end
    end
    ...
end
</code></pre>

<p>The &lsquo;new&rsquo; tests are straightforward. We remove the usage of an input parameter to the Populater initializer. The only significant change we make is to the &ldquo;empties pokemon collection&rdquo; test. Here we replace the Mongo Ruby Driver syntax of inserting into a collection with Mongoid syntax of creating a Pokemon document. The &lsquo;create&rsquo; method inserts a document into the collection with the given values, or defaults if none are given. We also see that we can remove the &ldquo;find&rdquo; syntax completely and just use a &ldquo;count&rdquo; method on the document type.</p>

<pre><code class="ruby project/tools/test/spec/populater_spec.rb">...
describe Populater do
    ...
    describe "#add_pokemon" do
        it "adds 0 pokemon given 0" do
            @populater.add_pokemon 0
            #@col.find.count.should eql 0 #removed
            Pokemon.count.should eql 0 #added
        end
        ...
        it "adds pokemon with a number" do
            @populater.add_pokemon 1
            #@col.find.count.should eql 1 #removed
            #@col.find.first['number'].should_not be_nil #removed
            Pokemon.count.should eql 1 #added
            Pokemon.first['number'].should_not be_nil #added
    end
      ...
    end
end
</code></pre>

<p>The tests for adding 0, 1, and 2 documents to the collection are all very similar. The only change is to replace the Mongo Ruby Driver &ldquo;find.count&rdquo; syntax with the Mongoid &ldquo;count.&rdquo; The &ldquo;adds pokemon with a ____&rdquo; tests all undergo the same changes. I replace the &ldquo;.find.first&rdquo; statement with a simple &ldquo;.first&rdquo; to get the same meaning. So our Populater has been converted to use Mongoid instead of the Mongo Ruby Driver. Bully for us.</p>

<p>There&rsquo;s one more change that would be nice to make before we hang up our hats. Configuring Mongoid using the .config syntax is okay, but it would be a lot nicer to keep all of our configuration in a file. We can create such a file called &ldquo;mongoid.yml&rdquo; and put some configuration information in it:</p>

<pre><code class="yml project/mongoid.yml">test:
  sessions:
    default:
      database: test
      hosts:
        - localhost
</code></pre>

<p>This syntax is valid in Mongoid 3.x. This is a very simply configuration for our test environment. Now we can go back into our test file and change the &lsquo;before:all&rsquo; block:</p>

<pre><code class="ruby project/tools/test/spec/populater_spec.rb">...
describe Populater do
    before:all do
        #Mongoid.configure do |config| #removed
        #   config.connect_to 'test' #removed
        #end # removed
        Mongoid.load! '../../../mongoid.yml', 'test' #added
    end
    ...
end
</code></pre>

<p>The second parameter can be a string or a symbol. Now there&rsquo;s only one file to modify the environment configurations, and we&rsquo;re better off for it.</p>
]]></content>
  </entry>
  
</feed>
