<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: capybara | Larry Price]]></title>
  <link href="http://larry-price.com/blog/categories/capybara/atom.xml" rel="self"/>
  <link href="http://larry-price.com/"/>
  <updated>2014-08-16T11:03:51-04:00</updated>
  <id>http://larry-price.com/</id>
  <author>
    <name><![CDATA[Larry Price]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Testing through a Trello connection with Capybara and Webkit]]></title>
    <link href="http://larry-price.com/blog/2014/08/07/testing-through-the-trello-api-with-capybara-and-webkit/"/>
    <updated>2014-08-07T07:25:11-04:00</updated>
    <id>http://larry-price.com/blog/2014/08/07/testing-through-the-trello-api-with-capybara-and-webkit</id>
    <content type="html"><![CDATA[<p>During the hardening of <a href="https://ollertapp.com">Ollert</a>, a Trello data analysis tool I wrote, I started writing acceptance tests. I quickly ran into an issue where the meat of my application requires opening pop-up window, signing into Trello, and allowing my application access.</p>




<p>I created a test user on Trello with a few varied boards to allow for proper testing. In doing this, I store the user&rsquo;s login information in my .env file. For the most part, I can use the steps provided in <a href="https://gist.github.com/larryprice/546d6c029bb3074bd84c">this common web_steps.rb</a>.</p>


<p><figure class='code'><figcaption><span>Connecting.feature</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="k">Feature:</span><span class="nf"> Landing</span>
</span><span class='line'>
</span><span class='line'><span class="k">Background:</span><span class="nf"></span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I am on the landing page</span>
</span><span class='line'>
</span><span class='line'><span class="nt">@javascript</span><span class="nf"></span>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Deny connecting to Trello</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I follow &quot;</span><span class="s">Connect to Get Started</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">I press &quot;</span><span class="s">Deny</span><span class="nf">&quot; on the Trello popup</span>
</span><span class='line'><span class="nf">  </span><span class="k">Then </span><span class="nf">I should be on the landing page</span>
</span><span class='line'>
</span><span class='line'><span class="nt">@javascript</span><span class="nf"></span>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Allow connecting to Trello</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I follow &quot;</span><span class="s">Connect to Get Started</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">When </span><span class="nf">I authorize with Trello as the test user</span>
</span><span class='line'><span class="nf">  </span><span class="k">Then </span><span class="nf">I should not see &quot;</span><span class="s">Connecting&hellip;</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">I should not see &quot;</span><span class="s">Redirecting&hellip;</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">I should be on the boards page</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>When the Trello popup appears, we have to specify the window we&rsquo;re going to use. Since I&rsquo;m using <a href="https://github.com/thoughtbot/capybara-webkit">capybara-webkit</a>, I&rsquo;m going to go ahead and do all of my Trello popup activities in one step, which saves me from writing a lot of unnecessary steps.</p>


<p><figure class='code'><figcaption><span>trello_popup_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">When</span> <span class="sr">/^I press &quot;(.*?)&quot; on the Trello popup$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">button</span><span class="o">|</span>
</span><span class='line'>  <span class="n">trello_popup</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">within_window</span> <span class="n">trello_popup</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">click_button</span> <span class="n">button</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">When</span> <span class="sr">/^I authorize with Trello as the test user$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">trello_popup</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">within_window</span> <span class="n">trello_popup</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">click_link</span> <span class="s2">&quot;Log in&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TEST_USER_TRELLO_USERNAME&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TEST_USER_TRELLO_PASSWORD&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">click_button</span> <span class="s2">&quot;Log In&quot;</span>
</span><span class='line'>    <span class="n">click_button</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Straightforward so far. We grab the window handle and we click links, fill in fields, and press buttons within that window.</p>




<p>Note that I&rsquo;m using capybara-webkit, a headless web driver, to run my Javascript. Although the first test (&ldquo;Deny&rdquo;) will pass, the &ldquo;Allow&rdquo; test fails ambiguously. This is because capybara-webkit is not recognized as a supported browser by the Trello popup.</p>




<p>Anecdotally, I contacted Trello support about this and received the following response:</p>




<blockquote><p>Currently it is not possible to test this with a headless browser as you are looking to do without getting the unsupported browser message.</p></blockquote>




<p>So I guess we should just give up, right? &hellip;Or we could manipulate the headers we send to load the Trello popup such that Trello <em>thinks</em> we are Google Chromium.</p>


<p><figure class='code'><figcaption><span>trello_popup_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="k">When </span><span class="nf">/^I authorize with Trello as the test user$/ do</span>
</span><span class='line'><span class="nf">  trello_popup = windows.last</span>
</span><span class='line'><span class="nf">  page.within_window trello_popup do</span>
</span><span class='line'><span class="nf">    page.driver.header(</span>
</span><span class='line'><span class="nf">      &quot;</span><span class="s">User-Agent</span><span class="nf">&quot;,</span>
</span><span class='line'><span class="nf">      &quot;</span><span class="s">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/34.0.1847.116 Chrome/34.0.1847.116 Safari/537.36</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    )</span>
</span><span class='line'>
</span><span class='line'><span class="nf">    click_link &quot;</span><span class="s">Log in</span><span class="nf">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">    fill_in &quot;</span><span class="s">user</span><span class="nf">&quot;, with: ENV[&#39;TEST_USER_TRELLO_USERNAME&#39;]</span>
</span><span class='line'><span class="nf">    fill_in &quot;</span><span class="s">password</span><span class="nf">&quot;, with: ENV[&#39;TEST_USER_TRELLO_PASSWORD&#39;]</span>
</span><span class='line'><span class="nf">    </span>
</span><span class='line'><span class="nf">    click_button &quot;</span><span class="s">Log In</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    click_button &quot;</span><span class="s">Allow</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'><span class="nf">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Fantastic. Now my tests pass. I can&rsquo;t sleep at night, but my tests pass.</p>




<p>Unfortunately, that won&rsquo;t be the case if I add more tests to this <code>.feature</code> file. Hidden somewhere deep in the browser&rsquo;s cache or cookies or somethings, Trello is remembering that we logged in sometimes. Sometimes it even remembers that someone else has logged in. The UI of the Trello popup changes based on whether it thinks you&rsquo;ve already logged in. In order to keep things consistent, I like to add an if-statement to take care of this case.</p>


<p><figure class='code'><figcaption><span>trello_popup_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="k">When </span><span class="nf">/^I authorize with Trello as the test user$/ do</span>
</span><span class='line'><span class="nf">  trello_popup = windows.last</span>
</span><span class='line'><span class="nf">  page.within_window trello_popup do</span>
</span><span class='line'><span class="nf">    page.driver.header(</span>
</span><span class='line'><span class="nf">      &quot;</span><span class="s">User-Agent</span><span class="nf">&quot;,</span>
</span><span class='line'><span class="nf">      &quot;</span><span class="s">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/34.0.1847.116 Chrome/34.0.1847.116 Safari/537.36</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    )</span>
</span><span class='line'>
</span><span class='line'><span class="nf">    if page.has_content? &quot;</span><span class="s">Switch Accounts</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">      click_link &quot;</span><span class="s">Switch Accounts</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    else</span>
</span><span class='line'><span class="nf">      click_link &quot;</span><span class="s">Log in</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    end</span>
</span><span class='line'>
</span><span class='line'><span class="nf">    fill_in &quot;</span><span class="s">user</span><span class="nf">&quot;, with: ENV[&#39;TEST_USER_TRELLO_USERNAME&#39;]</span>
</span><span class='line'><span class="nf">    fill_in &quot;</span><span class="s">password</span><span class="nf">&quot;, with: ENV[&#39;TEST_USER_TRELLO_PASSWORD&#39;]</span>
</span><span class='line'><span class="nf">    </span>
</span><span class='line'><span class="nf">    click_button &quot;</span><span class="s">Log In</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    click_button &quot;</span><span class="s">Allow</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'><span class="nf">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Edge cases addressed. Now I can make connections to Trello and test my application. Be warned, I&rsquo;ve already had these tests break once when Trello updated the UI behind the Trello popup. If Trello ever stops supporting Chromium 34.0, these tests are also likely to stop working. These tests are most useful during development, when we have the potential to break the Trello connection ourselves, and so I think they are well worth the pain of potential future maintenance.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Javascript testing with Capybara and Cucumber]]></title>
    <link href="http://larry-price.com/blog/2014/08/05/javascript-testing-with-capybara-and-cucumber/"/>
    <updated>2014-08-05T06:40:40-04:00</updated>
    <id>http://larry-price.com/blog/2014/08/05/javascript-testing-with-capybara-and-cucumber</id>
    <content type="html"><![CDATA[<p>In the past, I had written off testing the Javascript in my <a href="http://www.sinatrarb.com/">Sinatra</a> apps as being not worth the pain of setting up. That was pretty naïve of me, as setting up web drivers in <a href="https://github.com/jnicklas/capybara">Capybara</a> is actually pretty easy.</p>




<p>For this post, I assume you already have a capybara-cucumber project set up. If you need help setting up your first tests, consider checking out <a href="http://larry-price.com/blog/categories/capybara/">some of my other blog posts</a> on the subject.</p>




<h4>Selenium</h4>




<p>Selenium is the default Javascript driver for capybara. To install either run <code>gem install selenium-webdriver</code> or toss <code>selenium-webdriver</code> into your <code>Gemfile</code> and run <code>bundle install</code>.</p>




<p>If you want to run all of your tests with Javascript enabled, you can change the default driver in your <code>env.rb</code> file. For example:</p>


<p><figure class='code'><figcaption><span>env.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../../web&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;selenium-webdriver&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/cucumber&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="no">Ollert</span>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">default_wait_time</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># run all tests using Javascript</span>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">default_driver</span> <span class="o">=</span> <span class="ss">:selenium</span>
</span><span class='line'>
</span><span class='line'><span class="no">World</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Ollert</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="no">Mongoid</span><span class="o">.</span><span class="n">purge!</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Using Selenium means that your tests will be running using Firefox. Unfortunately, this makes them much, much slower than when you were running the tests using rspec. What I recommend is to limit yourself to only use the Javascript driver when you need to. To accomplish this, we change our <code>env.rb</code> file as such:</p>


<p><figure class='code'><figcaption><span>env.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../../web&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;selenium-webdriver&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/cucumber&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="no">Ollert</span>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">default_wait_time</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># use the following web driver to run tests</span>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">javascript_driver</span> <span class="o">=</span> <span class="ss">:selenium</span>
</span><span class='line'>
</span><span class='line'><span class="no">World</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Ollert</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="no">Mongoid</span><span class="o">.</span><span class="n">purge!</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And add the <code>@javascript</code> tag to our Cucumber feature files. I&rsquo;ve written <a href="http://larry-price.com/blog/2013/04/15/tags-in-c-plus-plus-cucumber-tests/">about using tags in the past</a>, and they are incredibly useful. For example:</p>


<p><figure class='code'><figcaption><span>DoStuff.feature</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="k">Feature:</span><span class="nf"> Do Stuff</span>
</span><span class='line'>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Nothing happens with Javascript disbaled</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I visit the home page</span>
</span><span class='line'><span class="nf">  </span><span class="k">When </span><span class="nf">I click &quot;</span><span class="s">Where are they?!</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">Then </span><span class="nf">I should not see &quot;</span><span class="s">I&#39;m Batman.</span><span class="nf">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">@javascript</span><span class="nf"></span>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Correct text is displayed with Javascript enabled</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I visit the home page</span>
</span><span class='line'><span class="nf">  </span><span class="k">When </span><span class="nf">I click &quot;</span><span class="s">Where are they?!</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">Then </span><span class="nf">I should see &quot;</span><span class="s">I&#39;m Batman.</span><span class="nf">&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Assuming there is some Javascript activated by clicking &ldquo;Where are they?!&rdquo; that displays the text &ldquo;I&rsquo;m Batman.&rdquo;, both of the above scenarios will pass. This is because none of the Javascript will run in the first scenario, so the text will not be displayed. In the second scenario, Capybara knows to use the webdriver we set up previously when it sees the <code>@javascript</code> tag.</p>




<h4>Poltergeist</h4>




<p><a href="https://github.com/teampoltergeist/poltergeist">Poltergeist</a> is the first &ldquo;headless&rdquo; web driver I tried. Usage is mostly identical to usage for Selenium, so I&rsquo;ll focus on installation here.</p>




<p>Poltergeist uses <a href="http://phantomjs.org/">PhantomJS</a>, so we need to start by downloading the binary (<a href="https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-1.9.7-linux-i686.tar.bz2">32-bit</a> or <a href="https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-1.9.7-linux-x86_64.tar.bz2">64-bit</a>) and putting it in our path. On my Linux machine, I extracted the contents of the download and copied <code>bin/phantomjs</code> to my <code>/usr/local/bin</code> directory, which I already have in my path. You can also copy it directly to <code>/usr/bin</code> if you like.</p>




<p>On the ruby side, we do that same old song and dance: either do <code>gem install poltergeist</code> or add <code>poltergeist</code> to your <code>Gemfile</code> and run <code>bundle install</code>. Edit your <code>env.rb</code>:</p>


<p><figure class='code'><figcaption><span>env.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="nf">ENV[&#39;RACK_ENV&#39;] = &#39;test&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">require_relative &#39;../../../web&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">require &#39;capybara/poltergeist&#39;</span>
</span><span class='line'><span class="nf">require &#39;capybara/cucumber&#39;</span>
</span><span class='line'><span class="nf">require &#39;rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">Capybara.app = Ollert</span>
</span><span class='line'><span class="nf">Capybara.default_wait_time = </span><span class="s">10</span><span class="nf"></span>
</span><span class='line'>
</span><span class='line'><span class="c"># use the following web driver to run tests</span><span class="nf"></span>
</span><span class='line'><span class="nf">Capybara.javascript_driver = :poltergeist</span>
</span><span class='line'>
</span><span class='line'><span class="nf">World do</span>
</span><span class='line'><span class="nf">  Ollert.new</span>
</span><span class='line'><span class="nf">  Mongoid.purge!</span>
</span><span class='line'><span class="nf">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now your Javascript tests should be running using the Poltergeist webdriver. Since Poltergeist is truly headless, your tests will run much faster than they did while using Selenium, but you won&rsquo;t be able to see what&rsquo;s going on while your tests run. There are some slight syntactic differences between the way Poltergeist and Selenium handles separate windows, but other than that they are extremely similar.</p>




<h4>Webkit</h4>




<p><a href="https://github.com/thoughtbot/capybara-webkit">Capybara-webkit</a> is where I eventually landed for running my own tests, after having issues accessing other windows with Poltergeist. Capybara-webkit is also headless and relies on <code>QtWebKit</code> to render pages. So, for starters, you&rsquo;re going to have to install <code>qtwebkit</code>. This has a varied degree of difficulty depending on which operating system you&rsquo;re using, but I didn&rsquo;t have too many problems in Ubuntu once I figured out which library I needed. For help, check <a href="https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit">the guide</a>. On my machine:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get install libqtwebkit-dev
</span></code></pre></td></tr></table></div></figure></p>

<p>Once more: either do <code>gem install capybara-webkit</code> or add <code>capybara-webkit</code> to your <code>Gemfile</code> and run <code>bundle install</code>. Edit your <code>env.rb</code>:</p>


<p><figure class='code'><figcaption><span>env.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="nf">ENV[&#39;RACK_ENV&#39;] = &#39;test&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">require_relative &#39;../../../web&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">require &#39;capybara/cucumber&#39;</span>
</span><span class='line'><span class="nf">require &#39;capybara/webkit&#39;</span>
</span><span class='line'><span class="nf">require &#39;rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">Capybara.app = Ollert</span>
</span><span class='line'><span class="nf">Capybara.default_wait_time = </span><span class="s">10</span><span class="nf"></span>
</span><span class='line'>
</span><span class='line'><span class="c"># use the following web driver to run tests</span><span class="nf"></span>
</span><span class='line'><span class="nf">Capybara.javascript_driver = :webkit</span>
</span><span class='line'>
</span><span class='line'><span class="nf">World do</span>
</span><span class='line'><span class="nf">  Ollert.new</span>
</span><span class='line'><span class="nf">  Mongoid.purge!</span>
</span><span class='line'><span class="nf">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Again, you won&rsquo;t be able to see your tests run, but they should be pretty snappy. I was able to use capybara-webkit to tackle some window issues I was having, but (as of this writing) capybara-webkit has not caught up with more modern capybara window-switching syntax. Other than that, the syntax is identical to the other drivers I&rsquo;ve discussed for common cases. If you&rsquo;re running capybara-webkit on a CI server, see <a href="http://blog.55minutes.com/2013/09/running-capybara-webkit-specs-with-jenkins-ci/">this post about using Xvfb</a>.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing a Sinatra App with Capybara]]></title>
    <link href="http://larry-price.com/blog/2013/01/19/testing-a-sinatra-app-with-capybara/"/>
    <updated>2013-01-19T12:20:00-05:00</updated>
    <id>http://larry-price.com/blog/2013/01/19/testing-a-sinatra-app-with-capybara</id>
    <content type="html"><![CDATA[<p><em>This is Part 3 in a multi-part series to detail the creation of a &ldquo;simple&rdquo; project combining <a href="http://www.ruby-lang.org/">Ruby</a>, <a href="http://www.mongodb.org/">MongoDB</a>, <a href="http://rspec.info/">RSpec</a>, <a href="http://www.sinatrarb.com/">Sinatra</a>, and <a href="https://github.com/jnicklas/capybara">Capybara</a> in preperation for a larger-scale side project set to begin January 2013. For more in this series, see the <a href="http://larry-price.com/blog/categories/pokephile">Pokephile category</a>. Part 3 of this series describes using Capybara to test a Sinatra application. The code for this side-project is located <a href="https://github.com/larryprice/Pokephile">on Github</a>, and the final product can be found <a href="http://pokephile.herokuapp.com">here</a>.</em></p>




<p>Now that <a href="http://larry-price.com/blog/2013/01/05/schemaless-databases-with-ruby-and-mongodb/">the database is populated</a> with data and I&rsquo;ve switched over to <a href="http://larry-price.com/blog/2013/01/05/moving-from-the-mongodb-ruby-driver-to-mongoid/">a simpler interface with Mongo</a>, I can actually start creating a UI. For simplicity&rsquo;s sake, I like to use Sinatra on small projects. Sinatra makes it easy to create a web application with minimal effort. With an emphasis on testing this <a href="http://larry-price.com/blog/categories/pokephile">series</a>, I want to be sure to throughly test my UI and any application integration. <a href="http://cukes.info/">Cucumber</a> is a brilliant DSL which allows a programmer to describe in plain English how an application should be behaving. The <a href="https://github.com/jnicklas/capybara">Capybara gem</a> is a Rack app that simulates running your application and performing basic user tasks, such as clicking a button, following a link, or, on a lower level, looking at your HTML source. Install Capybara like so:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo gem install capybara
</span></code></pre></td></tr></table></div></figure></p>

<p>Here&rsquo;s what I want my application to do:</p>




<ul>
<li>User is on home page.</li>
<li>User enters name of Pokemon and presses &lsquo;Search&rsquo;.</li>
<li>User is redirected to search page.</li>
<li>User can see some information about Pokemon.</li>
<li>User can repeat the search process.</li>
</ul>




<p>Error scenario:</p>




<ul>
<li>User enters garbage data.</li>
<li>User is redirected to search page.</li>
<li>User sees error message.</li>
<li>User can repeat search process.</li>
</ul>




<p>So I&rsquo;ll begin by writing my features. Cucumber syntax is meant to be readable by non-technical persons, so the &ldquo;code&rdquo; may look a bit odd. All Cucumber feature files are written something like this:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Cucumber'><span class='line'><span class="k">Feature:</span><span class="nf"> Viewer visits the Home Page</span>
</span><span class='line'><span class="nf">  In order to read the page</span>
</span><span class='line'><span class="nf">  As a viewer</span>
</span><span class='line'><span class="nf">  I want to see the home page of my app</span>
</span><span class='line'>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> View the home page</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I am on the home page</span>
</span><span class='line'><span class="nf"> </span><span class="k">Then </span><span class="nf">I should see &quot;</span><span class="s">Zowee, mama!</span><span class="nf">&quot; on the page</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The &ldquo;Feature&rdquo; lines are not used in testing; they are simply to give some relevance to the file&rsquo;s feature and to attempt to prevent scope creep in the file. The &ldquo;Scenario&rdquo; lines are what&rsquo;s important. The first line is the test name, the &ldquo;Given&rdquo; line is the pre-condition, and the final line is what should be observed.</p>




<p>In reality, I have only one main feature: &ldquo;Search.&rdquo; One can argue that I also have a feature of &ldquo;seeing&rdquo; my home page and my search page, but those are both trivial cases, so for the purpose of this blog post, I&rsquo;ll skip such tests. Both my success and error case revolves around searching, and there&rsquo;s not really much else to do in the app. I have to create a directory for the cukes, and that directory is called &ldquo;features.&rdquo; I create such a directory in my &ldquo;project/tools/test&rdquo; directory and create a new file called &ldquo;search.feature.&rdquo; Now I&rsquo;ll write the feature:</p>


<p><figure class='code'><figcaption><span>project/tools/test/features/search.feature</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='Cucumber'><span class='line'><span class="k">Feature:</span><span class="nf"> Viewer vists the page</span>
</span><span class='line'><span class="nf"> In order to search the page</span>
</span><span class='line'><span class="nf"> As a visitor</span>
</span><span class='line'><span class="nf"> I want to search for Pokemon.</span>
</span><span class='line'>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Find correct Pokemon from home page</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I am on the home page</span>
</span><span class='line'><span class="nf"> </span><span class="k">When </span><span class="nf">I type &quot;</span><span class="s">Bulbasaur</span><span class="nf">&quot; in the search bar</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I click &quot;</span><span class="s">Search</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">Then </span><span class="nf">I should be on the &quot;</span><span class="s">search</span><span class="nf">&quot; page</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see &quot;</span><span class="s">#001 - Bulbasaur</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see an image with url &quot;</span><span class="s"><a href="http://img.pokemondb.net/artwork/bulbasaur.jpg">http://img.pokemondb.net/artwork/bulbasaur.jpg</a></span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see &quot;</span><span class="s">Types: Grass, Poison</span><span class="nf">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Show error text from home page</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I am on the home page</span>
</span><span class='line'><span class="nf"> </span><span class="k">When </span><span class="nf">I type &quot;</span><span class="s">Johnny Bravo</span><span class="nf">&quot; in the search bar</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I click &quot;</span><span class="s">Search</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">Then </span><span class="nf">I should be on the &quot;</span><span class="s">search</span><span class="nf">&quot; page</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see &quot;</span><span class="s">Lol! Could not find a Pokemon named &#39;Johnny Bravo.&#39; Try something else!</span><span class="nf">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Find correct Pokemon from search page</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I am on the search page</span>
</span><span class='line'><span class="nf"> </span><span class="k">When </span><span class="nf">I type &quot;</span><span class="s">Bulbasaur</span><span class="nf">&quot; in the search bar</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I click &quot;</span><span class="s">Search</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">Then </span><span class="nf">I should see &quot;</span><span class="s">#001 - Bulbasaur</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see an image with url &quot;</span><span class="s"><a href="http://img.pokemondb.net/artwork/bulbasaur.jpg">http://img.pokemondb.net/artwork/bulbasaur.jpg</a></span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see &quot;</span><span class="s">Types: Grass, Poison</span><span class="nf">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">Scenario:</span><span class="nf"> Show error text from search page</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">I am on the search page</span>
</span><span class='line'><span class="nf"> </span><span class="k">When </span><span class="nf">I type &quot;</span><span class="s">Johnny Bravo</span><span class="nf">&quot; in the search bar</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I click &quot;</span><span class="s">Search</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf"> </span><span class="k">Then </span><span class="nf">I should be on the &quot;</span><span class="s">search</span><span class="nf">&quot; page</span>
</span><span class='line'><span class="nf"> </span><span class="k">And </span><span class="nf">I should see &quot;</span><span class="s">Lol! Could not find a Pokemon named &#39;Johnny Bravo.&#39; Try something else!</span><span class="nf">&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now I&rsquo;ve overlooked a lot of tests that one would normally write while doing this, such as verifying that the search bar and search buttons exist and are enabled, but I&rsquo;d like to keep it simple for now and just stick to testing my search feature. What do these tests do? The first scenario starts on the home page, enters data in the search box, presses the search button, and then verifies that all expected Pokemon data is visible. When writing cukes, I can append statements with an &ldquo;And&rdquo; statement as seen above. Run Cucumber:</p>


<p><figure class='code'><figcaption><span>project/tools/test</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cucumber
</span></code></pre></td></tr></table></div></figure></p>

<p>Cucumber doesn&rsquo;t exactly give us errors, but it also doesn&rsquo;t give us success. Fortunately, what it did give us was sample code for all of the steps we need to write. So, let&rsquo;s perform some copy/paste magic and create a steps file:</p>


<p><figure class='code'><figcaption><span>project/tools/test</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mkdir -p features/step_definitions
</span><span class='line'><span class="nv">$ </span>touch features/step_definitions/search_steps.rb
</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span>project/tools/test/features/step_definitions/search_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Given</span> <span class="sr">/^I am on the home page$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">When</span> <span class="sr">/^I type &quot;(.<em>?)&quot; in the search bar$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">When</span> <span class="sr">/^I click &quot;(.</em>?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span> <span class="sr">/^I should be on the &quot;(.<em>?)&quot; page$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span> <span class="sr">/^I should see &quot;(.</em>?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span> <span class="sr">/^I should see an image with url &quot;(.*?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Given</span> <span class="sr">/^I am on the search page$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pending</span> <span class="c1"># express the regexp above with the code you wish you had</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>If I futilely run &ldquo;cucumber&rdquo; again now, my tests still don&rsquo;t pass because I haven&rsquo;t actually implemented my steps. This is where Capybara comes in. I found that a <a href="https://gist.github.com/428105">Capybara cheat sheet</a> is quite helpful while writing out my steps. The syntax I&rsquo;m going to use is similar to RSpec, except that it includes some Capybara methods. The first two test steps I want to deal with are the &ldquo;Given&rdquo; steps.</p>


<p><figure class='code'><figcaption><span>project/tools/test/features/step_definitions/search_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Given</span> <span class="sr">/^I am on the home page$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">visit</span> <span class="s1">&#39;/&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Given</span> <span class="sr">/^I am on the search page$/</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">visit</span> <span class="s1">&#39;/&#39;</span>
</span><span class='line'>  <span class="n">click_button</span> <span class="s2">&quot;Search&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>All these statements are just Regular Expressions, as indicated by the /^$/. The regex acts as a sort of method name that Cucumber finds to run the steps. Given I am on the home page is trivial: just &lsquo;visit&rsquo; the index. Given I am on the search page will first require me to click the &ldquo;search&rdquo; button. This is valid because my spec above says this is how to get to the search page. Now can do the &lsquo;When&rsquo; statements.</p>


<p><figure class='code'><figcaption><span>project/tools/test/features/step_definitions/search_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">When</span> <span class="sr">/^I type &quot;(.<em>?)&quot; in the search bar$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">fill_in</span> <span class="s2">&quot;pokemon-input&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">arg1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">When</span> <span class="sr">/^I click &quot;(.</em>?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">click_button</span> <span class="n">arg1</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>When I click just needs to click a button/link/whatever on the screen. The &ldquo;(.*?)&rdquo; is a regular expression that will match anything in quotes and assign it to the variable &lsquo;arg1.&rsquo; So I can give any button description and Capybara will try to click a button with the given content. When I type in the search bar takes the regex arg1 and uses the &ldquo;fill_in&rdquo; method to fill in a text input with id &ldquo;pokemon-input.&rdquo; The rest of the steps are all about what should be observed after performing the Given/When steps.</p>


<p><figure class='code'><figcaption><span>project/tools/test/features/step_definitions/search_steps.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Then</span> <span class="sr">/^I should be on the &quot;(.<em>?)&quot; page$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">current_path</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;/</span><span class="si">#{</span><span class="n">arg1</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span> <span class="sr">/^I should see &quot;(.</em>?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span> <span class="sr">/^I should see an image with url &quot;(.*?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
</span><span class='line'>  <span class="n">find</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//img[@src=&#39;</span><span class="si">#{</span><span class="n">arg1</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now I have all of the necessary steps defined! So, I&rsquo;ll run Cucumber and&hellip; Actual errors! None of my four tests made it past the Given step, so I see the output &lsquo;(4 failed, 19 skipped).&rsquo; The only way to fix these errors is to finally start writing a web application. So I&rsquo;ll move back out to the root of my project directory and create a file for my application called &lsquo;app.rb&rsquo; and give it the most basic information to run. And, if you haven&rsquo;t already, install Sinatra.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo gem install sinatra
</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span>project/app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;haml&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">haml</span> <span class="ss">:index</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The Application class inherits from the Sinatra::Base class. This allows me to define a &lsquo;get&rsquo; operation to perform actions and load a web page. &lsquo;get \&rsquo;\&lsquo; do&rsquo; signifies the first page a user sees when they go to my web application, commonly known as a home or index page. I plan to use <a href="http://haml.info">HAML</a> to create my page, so I make a call to haml followed by the name of my HAML document as a symbol. We need to define an &lsquo;index.haml&rsquo; page and stick it in a directory called &lsquo;views&rsquo; for Sinatra to find it.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo gem install haml
</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span>project/views/index.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nn">!!!</span>
</span><span class='line'><span class="nt">%html</span>
</span><span class='line'>  <span class="nt">%head</span>
</span><span class='line'>      <span class="nt">%title</span> Pokemon App
</span><span class='line'>  <span class="nt">%body</span>
</span><span class='line'>      LOL HAI.
</span></code></pre></td></tr></table></div></figure></p>

<p>Tough work. If you&rsquo;re not familiar with HAML, it&rsquo;s a markup language that is &ldquo;compiled&rdquo; into an HTML page. The main difference between HAML and HTML is that HAML parses white space to figure out where closing tags should be placed. So now I want to run my application. I want to run it using &lsquo;rackup,&rsquo; so I&rsquo;d like to define a &lsquo;config.ru&rsquo; file in the root of my project directory to do all the work for me.</p>


<p><figure class='code'><figcaption><span>project/config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;./app&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span> <span class="no">Application</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now we run &lsquo;rackup&rsquo; from the root of my project directory and see the fruits of my labor. Open up a web browser and enter &lsquo;localhost:9292&rsquo; in the address bar. You should see a very simple web page with the content of &ldquo;LOL HAI&rdquo; and a title of &ldquo;Pokemon App.&rdquo; If you view the source, you&rsquo;ll see the HTML the HAML was compiled into. Just beautiful, isn&rsquo;t it? Now if I switch back to my test directory and run Cucumber, what happens? The same result. That&rsquo;s because I need to tell Capybara what to load before trying to run the tests. I do this by defining an &ldquo;env.rb&rdquo; file in a &ldquo;support&rdquo; directory of the features directory.</p>


<p><figure class='code'><figcaption><span>project/tools/test/features/support/env.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/cucumber&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">require_relative</span> <span class="s2">&quot;../../../../app&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="no">Application</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>All I do is require my &ldquo;app.rb&rdquo; file which is seemingly <em>forever</em> away and then set the Capybara.app variable to my Application class. Now I run Cucumber and&hellip; &lsquo;(4 failed, 17 skipped, 2 passed)&rsquo; Two steps passed! Yippee! Now if only the rest passed as well. Looking at my &lsquo;search.feature&rsquo; file, I can see that the first &lsquo;When&rsquo; step is about typing into the search bar. So my first design decision is what kind of search bar I want. I&rsquo;ve opted for the fun way out: using the <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap&rsquo;s</a> <a href="http://twitter.github.com/bootstrap/javascript.html#typeahead">typeahead</a>. The typeahead has functionality to give suggestions while the user types, and the best news is this is already coded for us. Adding the code for my search bar and a search button:</p>


<p><figure class='code'><figcaption><span>project/views/index.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nn">!!!</span>
</span><span class='line'><span class="nt">%html</span>
</span><span class='line'>  <span class="nt">%head</span>
</span><span class='line'>      <span class="nt">%title</span> Pokemon App
</span><span class='line'>      <span class="nt">%link</span>(<span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;<a href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css&amp;quot;">http://twitter.github.com/bootstrap/assets/css/bootstrap.css&amp;quot;</a></span>)
</span><span class='line'>  <span class="nt">%body</span>
</span><span class='line'>      <span class="nt">%script</span><span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">,</span> <span class="ss">:src</span>  <span class="o">=&gt;</span> <span class="s2">&quot;<a href="http://code.jquery.com/jquery.min.js&amp;quot;">http://code.jquery.com/jquery.min.js&amp;quot;</a></span><span class="p">}</span>
</span><span class='line'>      <span class="nt">%script</span><span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">,</span> <span class="ss">:src</span>  <span class="o">=&gt;</span> <span class="s2">&quot;<a href="http://twitter.github.com/bootstrap/assets/js/bootstrap-typeahead.js&amp;quot;">http://twitter.github.com/bootstrap/assets/js/bootstrap-typeahead.js&amp;quot;</a></span><span class="p">}</span>
</span><span class='line'>      <span class="nf">#search</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 10%;&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="nt">%form</span><span class="p">{</span><span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;pokemon-search&quot;</span><span class="p">}</span>
</span><span class='line'>              <span class="nt">%input</span><span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;input-large&quot;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;pokemon-input&quot;</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;pokemon&quot;</span><span class="p">,</span> <span class="s2">&quot;data-provide&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;typeahead&quot;</span><span class="p">,</span> <span class="s2">&quot;data-items&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;autocomplete&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="ss">:autofocus</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:placeholder</span> <span class="o">=&gt;</span> <span class="s2">&quot;Find a Pokémon&hellip;&quot;</span><span class="p">,</span> <span class="s2">&quot;data-source&quot;</span> <span class="o">=&gt;</span> <span class="no">Pokemon</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>}
</span><span class='line'>              <span class="nt">%button</span><span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;btn btn-small&quot;</span><span class="p">,</span> <span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;margin-bottom: 10px; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>                  Search
</span></code></pre></td></tr></table></div></figure></p>

<p>In the \&lt;head> tag, I include a link to the Bootstrap stylesheet. In the \&lt;body> tag, I include a link to the JQuery and Bootstrap Typeahead JavaScript files remotely so I don&rsquo;t have to keep track of them. I then add a \&lt;div> tag called &ldquo;search&rdquo; and center it on the page. Inside the div tag I create a form whose action sends a POST signal to the &ldquo;search&rdquo; action. Inside the form is first the typeahead, then a small submit button. The important parameters in the typeahead are &ldquo;data-items&rdquo; and &ldquo;data-source;&rdquo; &ldquo;data-items&rdquo; tells the JavaScript function how many items to suggest at a time, and &ldquo;data-source&rdquo; is an array of data for the JavaScript to search. Notice that my &ldquo;data-source&rdquo; uses the Pokemon class <a href="http://larry-price.com/blog/2013/01/05/schemaless-databases-with-ruby-and-mongodb/">created previously</a>, so I need to be able to set up a <a href="http://larry-price.com/blog/2013/01/05/moving-from-the-mongodb-ruby-driver-to-mongoid/">Mongoid connection</a> to access that data. I&rsquo;ll make this connection in my &ldquo;config.ru&rdquo; file:</p>


<p><figure class='code'><figcaption><span>project/config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;./app&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mongoid&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span>
</span><span class='line'>  <span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Mongoid</span><span class="o">.</span><span class="n">load!</span> <span class="s1">&#39;mongoid.yml&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span> <span class="no">Application</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I have chosen to extend the Application class in my &ldquo;config.ru&rdquo; file to prevent interference with my test setups later. Taking a look at the application would be a good idea, but if I run &ldquo;rackup&rdquo; now Mongoid will complain about environment setup. By default, &ldquo;Mongoid.load!&rdquo; will try to load the &ldquo;development&rdquo; settings, so I need to include a &ldquo;development&rdquo; setup in my &ldquo;mongoid.yml.&rdquo; For now, it&rsquo;s going to be identical to my &ldquo;test&rdquo; environment setup except for the database name:</p>


<p><figure class='code'><figcaption><span>project/mongoid.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sessions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>      <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sessions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dev</span>
</span><span class='line'>      <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">localhost</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And ensuring some Pokemon are in the &ldquo;dev&rdquo; database:</p>


<p><figure class='code'><figcaption><span>Populating the dev database</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>irb
</span><span class='line'>&gt;&gt; Dir.pwd
</span><span class='line'><span class="o">=</span>&gt; <span class="s2">&quot;project/tools/populate&quot;</span>
</span><span class='line'>&gt;&gt; require <span class="s1">&#39;mongoid&#39;</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="nb">true</span>
</span><span class='line'>&gt;&gt; Mongoid.load! <span class="s1">&#39;../../mongoid.yml&#39;</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;sessions&quot;</span><span class="o">=</span>&gt;<span class="o">{</span><span class="s2">&quot;default&quot;</span><span class="o">=</span>&gt;<span class="o">{</span><span class="s2">&quot;database&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;dev&quot;</span>, <span class="s2">&quot;hosts&quot;</span><span class="o">=</span>&gt;<span class="o">[</span><span class="s2">&quot;localhost&quot;</span><span class="o">]}}}</span>
</span><span class='line'>&gt;&gt; require <span class="s1">&#39;./populater&#39;</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="nb">true</span>
</span><span class='line'>&gt;&gt; Populater.new.add_pokemon <span class="nv">152</span>
</span><span class='line'><span class="o">=</span>&gt; nil
</span><span class='line'>&gt;&gt;
</span></code></pre></td></tr></table></div></figure></p>

<p>And requiring the Pokemon model in app.rb:</p>


<p><figure class='code'><figcaption><span>project/app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;haml&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;pokemon&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">haml</span> <span class="ss">:index</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Finally, run &lsquo;rackup&rsquo; from the root of the &lsquo;project&rsquo; directory and load up the web application at &lsquo;localhost:9292.&rsquo; There&rsquo;s now a typeahead and a search button in the top center of the page, and typing in the &lsquo;Search&rsquo; bar shows up to 10 suggestion Pokemon. Now I&rsquo;ll return to my Cucumber tests. I need to add a line in the &lsquo;env.rb&rsquo; file to set up the Mongoid environment and ensure there are Pokemon in the collection.</p>


<p><figure class='code'><figcaption><span>project/tools/test/features/support/env.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/cucumber&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mongoid&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../../populate/populater&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s2">&quot;../../../../app&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Mongoid</span><span class="o">.</span><span class="n">load!</span> <span class="s1">&#39;../../mongoid.yml&#39;</span><span class="p">,</span> <span class="ss">:test</span>
</span><span class='line'>
</span><span class='line'><span class="no">Populater</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">add_pokemon</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="no">Application</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now I can run Cucumber and see some jovial results: &lsquo;(4 failed, 9 skipped, 10 passed).&rsquo; I now have more steps passing than failing! The root cause of the failures is that there currently is no &ldquo;search&rdquo; page; let&rsquo;s fix that:</p>


<p><figure class='code'><figcaption><span>project/app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">post</span> <span class="s1">&#39;/search&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">haml</span> <span class="ss">:search</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I want my search page to have a search bar just like my index page. If I want them to be identical, I want to only have to change that code once. When writing HAML, I can create a &lsquo;layout.haml&rsquo; file to act as a base page for my application and move all the text from &lsquo;index.haml.&rsquo; I&rsquo;ll add a &lsquo;=yield&rsquo; statement where I want the information from &lsquo;index.haml&rsquo; and &lsquo;search.haml&rsquo; to be placed.</p>


<p><figure class='code'><figcaption><span>project/views/layout.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nn">!!!</span>
</span><span class='line'><span class="nt">%html</span>
</span><span class='line'>  <span class="nt">%head</span>
</span><span class='line'>      <span class="nt">%title</span> Pokemon App
</span><span class='line'>      <span class="nt">%link</span>(<span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;<a href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css&amp;quot;">http://twitter.github.com/bootstrap/assets/css/bootstrap.css&amp;quot;</a></span>)
</span><span class='line'>  <span class="nt">%body</span>
</span><span class='line'>      <span class="nt">%script</span><span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">,</span> <span class="ss">:src</span>  <span class="o">=&gt;</span> <span class="s2">&quot;<a href="http://code.jquery.com/jquery.min.js&amp;quot;">http://code.jquery.com/jquery.min.js&amp;quot;</a></span><span class="p">}</span>
</span><span class='line'>      <span class="nt">%script</span><span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">,</span> <span class="ss">:src</span>  <span class="o">=&gt;</span> <span class="s2">&quot;<a href="http://twitter.github.com/bootstrap/assets/js/bootstrap-typeahead.js&amp;quot;">http://twitter.github.com/bootstrap/assets/js/bootstrap-typeahead.js&amp;quot;</a></span><span class="p">}</span>
</span><span class='line'>      <span class="nf">#search</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 10%;&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="nt">%form</span><span class="p">{</span><span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;pokemon-search&quot;</span><span class="p">}</span>
</span><span class='line'>              <span class="nt">%input</span><span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;input-large&quot;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;pokemon-input&quot;</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;pokemon&quot;</span><span class="p">,</span> <span class="s2">&quot;data-provide&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;typeahead&quot;</span><span class="p">,</span> <span class="s2">&quot;data-items&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;autocomplete&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="ss">:autofocus</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:placeholder</span> <span class="o">=&gt;</span> <span class="s2">&quot;Find a Pokémon&hellip;&quot;</span><span class="p">,</span> <span class="s2">&quot;data-source&quot;</span> <span class="o">=&gt;</span> <span class="no">Pokemon</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>}
</span><span class='line'>              <span class="nt">%button</span><span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;btn btn-small&quot;</span><span class="p">,</span> <span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;margin-bottom: 10px; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>                  Search
</span><span class='line'>      <span class="p">=</span><span class="k">yield</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span>project/views/index.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#search-text</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 2%; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>  Begin typing to search for your Pokemon!
</span></code></pre></td></tr></table></div></figure></p>

<p>At this point, I&rsquo;ll create a &lsquo;search.haml&rsquo; file in the &lsquo;views&rsquo; directory, but leave it empty. Running Cucumber now, I get &lsquo;(4 failed, 4 skipped, 15 passed).&rsquo; Pretty close! All I fail now is actually seeing the desired information on the page. First I want to get access to the Pokemon searched for: I can do that by parsing the params passed to us in app.rb:</p>


<p><figure class='code'><figcaption><span>project/app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">post</span> <span class="s1">&#39;/search&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@pokemon</span> <span class="o">=</span> <span class="no">Pokemon</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:pokemon</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">haml</span> <span class="ss">:search</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>So now on my search page:</p>


<p><figure class='code'><figcaption><span>project/views/search.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#search-text</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 2%; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>  Search for another Pokemon.
</span><span class='line'><span class="nf">#search-results</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 20%; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="nt">%img</span><span class="p">{</span><span class="ss">:src</span> <span class="o">=&gt;</span> <span class="vi">@pokemon</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="ss">:height</span> <span class="o">=&gt;</span> <span class="s2">&quot;250px&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="nt">%br</span>
</span><span class='line'>  <span class="p">=</span> <span class="s2">&quot;#</span><span class="si">#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nt">%br</span>
</span><span class='line'>  <span class="p">=</span> <span class="s2">&quot;Types: </span><span class="si">#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">first</span><span class="si">}#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="s1">&#39; &#39;</span> <span class="p">:</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="vi">@pokemon</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">last</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I reference the class variable &ldquo;@pokemon&rdquo; and access its data. To output Ruby-formatted strings, I use an &ldquo;=&rdquo; sign. Running Cucumber, I now see &lsquo;(2 failed, 21 passed).&rsquo; 2 of my 4 tests are passing! A trivial amount of investigation reveals that I didn&rsquo;t deal with the situation where the user types in garbage data. That can mostly be done in the HAML file, but I also want a way to get the bad text the user gave me so they can see what was wrong.</p>


<p><figure class='code'><figcaption><span>project/views/search.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#search-text</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 2%; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>  Search for another Pokemon.
</span><span class='line'><span class="nf">#search-results</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;position: absolute; width: 100%; text-align: center; top: 20%; font-weight: bold;&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="p">-</span> <span class="k">unless</span> <span class="vi">@pokemon</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>      <span class="nt">%img</span><span class="p">{</span><span class="ss">:src</span> <span class="o">=&gt;</span> <span class="vi">@pokemon</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="ss">:height</span> <span class="o">=&gt;</span> <span class="s2">&quot;250px&quot;</span><span class="p">}</span>
</span><span class='line'>      <span class="nt">%br</span>
</span><span class='line'>      <span class="p">=</span> <span class="s2">&quot;#</span><span class="si">#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="nt">%br</span>
</span><span class='line'>      <span class="p">=</span> <span class="s2">&quot;Types: </span><span class="si">#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">first</span><span class="si">}#{</span><span class="vi">@pokemon</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="s1">&#39; &#39;</span> <span class="p">:</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="vi">@pokemon</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">last</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="p">-</span> <span class="k">else</span>
</span><span class='line'>      <span class="p">=</span> <span class="s2">&quot;Lol! Could not find a Pokemon named &#39;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">.&#39; Try something else!&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><figcaption><span>project/app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">post</span> <span class="s1">&#39;/search&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@name</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:pokemon</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@pokemon</span> <span class="o">=</span> <span class="no">Pokemon</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="vi">@name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">haml</span> <span class="ss">:search</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Ruby code with no output is preceded with a &lsquo;-&rsquo; and because HAML is space-sensitive, there&rsquo;s no need to include &lsquo;end&rsquo; statements. Now I run Cucumber and&hellip; 4 scenarios/23 steps passed! I have a functional web application! Of course, the page itself is somewhat bland, some of the styles could be put in a stylesheet and reused, and the only tests I&rsquo;ve written are for super-high-level functionality. Those are all problems someone with infinite time would deal with, so I&rsquo;ll just leave the page is is for now.</p>




<p>The next blog post <a href="http://larry-price.com/blog/categories/pokephile">in this series</a> will be about deploying this application to the web using Heroku.</p>

]]></content>
  </entry>
  
</feed>
